/*! For license information please see 5899.2632c76d.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[5899],{5899:(e,t,s)=>{s.d(t,{I:()=>He});var r=s(34904),o=s(30636),n=s(27250),i=s(14826);async function a(e,t){return t(await s.e(72883).then(s.bind(s,39480)).then(t=>(e.sendTelemetryEvent({eventName:"createNewModuleLoaded"}),t)).catch(t=>{throw e.sendErrorEvent({eventName:"createNewModuleLoadFailed"},t),t}))}var h=s(91119),c=s(33669),l=s(20611);class d{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36e5;this.snapshotExpiryPolicy=e,this.cache=new Map,this.docIdExpirationMap=new Map}async get(e){const t=(0,l.V$)(e);return this.cache.get(t)}async put(e,t){const s=(0,l.V$)(e);this.cache.set(s,t),this.updateExpirationEntry(e.file.docId)}async removeEntries(e){this.removeDocIdEntriesFromCache(e.docId)}removeDocIdEntriesFromCache(e){return this.removeExpirationEntry(e),[...this.cache].filter(t=>{let[s]=t;if(s.split("_")[0]===e)return!0}).map(e=>{let[t]=e;this.cache.delete(t)})}removeExpirationEntry(e){const t=this.docIdExpirationMap.get(e);void 0!==t&&(clearTimeout(t),this.docIdExpirationMap.delete(e))}updateExpirationEntry(e){this.removeExpirationEntry(e),this.docIdExpirationMap.set(e,setTimeout(()=>{this.removeDocIdEntriesFromCache(e)},this.snapshotExpiryPolicy))}}c.o;class u{constructor(){this.sessionJoinCache=new c.o,this.fileUrlCache=new c.o,this.snapshotPrefetchResultCache=new c.o}}var p=s(88826),g=s(85038),m=s(63520);function f(e,t){let s,r,o,n,i,a,h,c;const l=globalThis.performance.getEntriesByType?.("resource")??[];for(let d=l.length-1;d>0;d--){const u=l[d],p=u.name.toString();if(0===u.initiatorType.localeCompare(t)&&p.includes(e)){r=u.redirectEnd-u.redirectStart,c=u.fetchStart,s=u.domainLookupEnd-u.domainLookupStart,o=u.connectEnd-u.connectStart,n=u.secureConnectionStart>0?u.connectEnd-u.secureConnectionStart:0,i=u.responseStart>0?u.responseEnd-u.responseStart:void 0,a=u.fetchStart>0?u.responseEnd-u.fetchStart:void 0,h=u.requestStart>0?u.responseEnd-u.requestStart:void 0;break}}return{dnsLookupTime:s,w3cStartTime:c,redirectTime:r,tcpHandshakeTime:o,secureConnectionTime:n,responseNetworkTime:i,fetchStartToResponseEndTime:a,reqStartToResponseEndTime:h}}function b(e,t,s,r){let o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(0!==t.length){const n=t[0].sequenceNumber,i=t.length,a=t[i-1].sequenceNumber;if(a+1!==s+i){if(o||s!==n)t.length=0;else{let e=1;for(;e<t.length&&t[e].sequenceNumber===t[e-1].sequenceNumber+1;)e++;t.length=e}r.sendErrorEvent({eventName:"OpsFetchViolation",reason:e,from:s,start:n,last:a,length:i,details:JSON.stringify({validLength:t.length,lastValidOpSeqNumber:t.length>0?t[t.length-1].sequenceNumber:void 0,strict:o})})}}}var v=s(87615),y=s(8018),S=s(54813);function w(e,t,s){const r={...t},o=s?.online;if(r.online="string"===typeof o?o:S.WA[(0,S.sc)()],"object"===typeof navigator&&null!==navigator){const e=navigator,t=e.connection??e.mozConnection??e.webkitConnection;null!==t&&"object"===typeof t&&(r.connectionType=t.type)}r.category=(0,S.YU)(s)?"generic":"error",e.sendTelemetryEvent(r,s)}var T=s(65199),C=s(70354);class k{get working(){return"working"===this.workingState}get canceled(){return"canceled"===this.workingState}constructor(e,t,s,r,o,n){this.to=t,this.payloadSize=s,this.logger=r,this.requestCallback=o,this.responseCallback=n,this.results=new Map,this.workingState="working",this.requestsInFlight=0,this.endEvent=new y.c,this.requests=0,this.latestRequested=e,this.nextToDeliver=e,this.knewTo=void 0!==t}cancel(){this.working&&(this.workingState="canceled",this.endEvent.resolve())}async run(e){(0,g.vA)(e>0,258),(0,g.vA)(this.working,259);let t=e;for(;t>0;)t--,this.addRequest();return this.dispatch(),this.endEvent.promise}done(){(0,g.vA)(void 0!==this.to,260),(0,g.vA)(this.nextToDeliver>=this.to,261),this.working&&(this.workingState="done",this.endEvent.resolve())}fail(e){this.working&&(this.workingState="done",this.endEvent.reject(e))}dispatch(){for(;this.working;){const e=this.results.get(this.nextToDeliver);if(void 0===e)break;this.results.delete(this.nextToDeliver),(0,g.vA)(e.length<=this.payloadSize,473),this.nextToDeliver+=e.length,this.responseCallback(e)}this.working&&(0===this.requestsInFlight?((0,g.vA)(0===this.results.size,263),this.done()):void 0!==this.to&&this.nextToDeliver>=this.to&&((0,g.vA)(!this.knewTo,264),this.done()))}getNextChunk(){if(!this.working)return;const e=this.latestRequested;return void 0!==this.to&&this.to<=e?void 0:(this.latestRequested+=this.payloadSize,void 0!==this.to&&(this.latestRequested=Math.min(this.to,this.latestRequested)),(0,g.vA)(e<this.latestRequested,265),{from:e,to:this.latestRequested})}addRequest(){const e=this.getNextChunk();void 0!==e&&this.addRequestCore(e.from,e.to).catch(this.fail.bind(this))}async addRequestCore(e,t){(0,g.vA)(this.working,266);let s=e,r=t;for(this.requestsInFlight++;this.working;){const e=r-s;(0,g.vA)(e>0,267),void 0!==this.to&&((0,g.vA)(s<this.to,268),(0,g.vA)(r<=this.to,269)),this.requests++;const t=this.requestCallback(this.requests,s,r,void 0!==this.to,{});this.dispatch();const{payload:o,cancel:n,partial:i}=await t;if(n&&this.cancel(),void 0!==this.to&&s>=this.to){(0,g.vA)(!this.knewTo,270),0!==o.length&&this.logger.sendErrorEvent({eventName:"ParallelRequests_GotExtra",from:s,to:r,end:this.to,length:o.length});break}if(this.working){const t=s,n=o.length;let a=e<=n;if(0!==n){e<n&&this.logger.sendTelemetryEvent({eventName:"ParallelRequests_Over",from:s,to:r,length:n});const t=o.splice(0,e);this.results.set(s,t),s+=t.length}else(0,g.vA)(!i,271),(0,g.vA)(!this.knewTo,272);if(!i&&!a){if(!this.knewTo){(void 0===this.to||this.to>s)&&(this.to=s);break}this.logger.sendPerformanceEvent({eventName:"ParallelRequests_Partial",from:t,to:r,length:n})}if(r===this.latestRequested){for(;0!==o.length;){const t=o.splice(0,e);this.results.set(s,t),s+=t.length}this.latestRequested=s,a=!0}if(a){const e=this.getNextChunk();if(void 0===e)break;s=e.from,r=e.to}}}this.requestsInFlight--,this.dispatch()}}class E{constructor(){this.queue=[],this.done=!1}pushValue(e){this.pushCore(Promise.resolve({done:!1,value:e}))}pushError(e){this.pushCore(Promise.reject(e)),this.done=!0}pushDone(){this.pushCore(Promise.resolve({done:!0})),this.done=!0}pushCore(e){(0,g.vA)(!this.done,274),this.deferred?((0,g.vA)(0===this.queue.length,275),this.deferred.resolve(e),this.deferred=void 0):this.queue.push(e)}async read(){(0,g.vA)(void 0===this.deferred,276);const e=this.queue.shift();return void 0!==e?e:((0,g.vA)(!this.done,277),this.deferred=new y.c,this.deferred.promise)}}const N=async()=>{if(!1===globalThis.navigator?.onLine&&void 0!==globalThis.addEventListener)return new Promise(e=>{const t=()=>{e(),globalThis.removeEventListener("online",t)};globalThis.addEventListener("online",t)})};function I(e,t,s,r,o,i,a,h){let c,l=0,d=0;const u=new E,p={fromTotal:s,toTotal:r},m=n.Bt.start(i,{eventName:"GetDeltas",...p,reason:h}),f=new k(s,r,o,i,async(t,s,r,o,c)=>(l++,async function(e,t,s,r,o,i){let a,h,c=0,l=0,d=0,u=50;for(;!0!==o?.aborted;){let o;l++;const g=(0,v.l)();try{const{messages:r,partialResult:o}=await e({...t,retry:l});if(0!==r.length||!s)return h?.end({duration:c,...t,reason:i}),{payload:r,cancel:!1,partial:o};if(void 0===a)a=(0,v.l)();else if((0,v.l)()-a>3e4)throw(0,S.ix)("Failed to retrieve ops from storage (Too Many Retries)",{canRetry:!1},{retry:l,driverVersion:T.z,...t})}catch(p){o=p;const e=(0,S.YU)(p),s=(0,S.E9)(p);if(w(r,{eventName:"GetDeltas_Error",...t,retry:l,duration:(0,v.l)()-g,retryAfter:s,reason:i},p),!e)throw p}void 0===h&&(d=(0,v.l)(),h=n.Bt.start(r,{eventName:"GetDeltasWaitTime"})),u=(0,C.F)(u,o),await new Promise(e=>{setTimeout(e,u)}),await N(),c+=(0,v.l)()-d}return{partial:!1,cancel:!0,payload:[]}}(async t=>e(s,r,t),{request:t,from:s,to:r,...p,...c},o,i,a,h)),e=>{void 0===c?(0,g.vA)(e[0].sequenceNumber===s,621):(0,g.vA)(e[0].sequenceNumber===c+1,622),c=e[e.length-1].sequenceNumber,(0,g.vA)(c-e[0].sequenceNumber+1===e.length,623),d+=e.length,u.pushValue(e)}),b=e=>{f.cancel()};return void 0!==a&&a.addEventListener("abort",b),f.run(t).finally(()=>{void 0!==a&&a.removeEventListener("abort",b)}).then(()=>{const e={lastFetch:c,length:d,requests:l};f.canceled?m.cancel({...e,error:"ops request cancelled by client"}):((0,g.vA)(void 0===r||void 0!==c&&c>=r-1,624),m.end(e)),u.pushDone()}).catch(e=>{m.cancel({lastFetch:c,length:d,requests:l},e),u.pushError(e)}),u}var A=s(70530);class L{constructor(e,t,s,r){this.deltaFeedUrl=e,this.getAuthHeader=t,this.epochTracker=s,this.logger=r}async get(e,t,s,r){return(0,A.gO)(async o=>{const a=this.buildUrl(e,t),h="POST",c=await this.getAuthHeader({...o,request:{url:a,method:h}},"DeltaStorage");return n.Bt.timedExecAsync(this.logger,{eventName:"OpsFetch",attempts:o.refresh?2:1,from:e,to:t,...s,reason:r},async e=>{const t=(0,i.A)();let s=`--${t}\r\n`;s+=`Authorization: ${c}\r\n`,s+="X-HTTP-Method-Override: GET\r\n",s+="_post: 1\r\n",s+=`\r\n--${t}--`;const o={"Content-Type":`multipart/form-data;boundary=${t}`},n=new AbortController,l=setTimeout(()=>n.abort(),3e4),d=await this.epochTracker.fetchAndParseAsJSON(a,{headers:o,body:s,method:h,signal:n.signal},"ops",!0,r);clearTimeout(l);const u=d.content,p=u.value.length>0&&"op"in u.value[0]?u.value.map(e=>e.op):u.value;return e.end({length:p.length,...d.propsToLog}),{messages:p,partialResult:!1}})})}buildUrl(e,t){const s=`?ump=1&filter=${encodeURIComponent(`sequenceNumber ge ${e} and sequenceNumber le ${t-1}`)}`;return`${this.deltaFeedUrl}${s}`}}class P{constructor(e,t,s,r,o,n,i,a,h){this.snapshotOps=e,this.logger=t,this.batchSize=s,this.concurrency=r,this.getFromStorage=o,this.getCached=n,this.requestFromSocket=i,this.opsReceived=a,this.storageManagerGetter=h,this.useCacheForOps=!0}fetchMessages(e,t,s,r,o){(0,g.vA)(!r||void 0===t,483),this.useCacheForOps=this.useCacheForOps&&!1===this.storageManagerGetter()?.isFirstSnapshotFromNetwork;let n=0,i=0,a=0;const h=async(e,t,s)=>{if(void 0!==this.snapshotOps&&this.snapshotOps.length>0){const s=this.snapshotOps.filter(s=>s.sequenceNumber>=e&&s.sequenceNumber<t);if(b("cached",s,e,this.logger),s.length>0&&s[0].sequenceNumber===e)return this.snapshotOps=this.snapshotOps.filter(e=>e.sequenceNumber>=t),n+=s.length,{messages:s,partialResult:!0};this.snapshotOps=void 0}if(this.requestFromSocket(e,t),this.useCacheForOps){const s=await this.getCached(e,t);if(b("cached",s,e,this.logger),this.useCacheForOps=e+s.length>=t,s.length>0)return i+=s.length,{messages:s,partialResult:!0}}if(r)return{messages:[],partialResult:!1};const h=await this.getFromStorage(e,t,s,o);return b("storage",h.messages,e,this.logger),a+=h.messages.length,this.opsReceived(h.messages),h};return function(e,t){return{read:async()=>{const s=await e.read();return t(s),s}}}(I(async(e,t,s)=>{const r=await h(e,t,s);return b("catch all",r.messages,e,this.logger),r},this.concurrency,e,t,this.batchSize,this.logger,s,o),e=>{e.done&&n+i+a!==0&&this.logger.sendPerformanceEvent({eventName:"CacheOpsRetrieved",opsFromSnapshot:n,opsFromCache:i,opsFromStorage:a,reason:o})})}}var R,B,F=s(97813),O=s(14365);!function(e){e[e.NoCaching=0]="NoCaching",e[e.Prefetch=1]="Prefetch"}(R||(R={})),function(e){e.default="default",e.noCache="noCache"}(B||(B={}));var q,U,D,x=s(21673),M=s(93586),z=s(39521),G=s(68194);!function(e){e.NoOp="noop",e.ClientJoin="join",e.ClientLeave="leave",e.Propose="propose",e.Reject="reject",e.Accept="accept",e.Summarize="summarize",e.SummaryAck="summaryAck",e.SummaryNack="summaryNack",e.Operation="op",e.NoClient="noClient",e.RoundTrip="tripComplete",e.Control="control"}(q||(q={})),function(e){e.ClientJoin="join",e.ClientLeave="leave"}(U||(U={})),function(e){e.ThrottlingError="ThrottlingError",e.InvalidScopeError="InvalidScopeError",e.BadRequestError="BadRequestError",e.LimitExceededError="LimitExceededError"}(D||(D={}));var _=s(84295),$=s(83533);class W{get buffer(){return this.data}constructor(e){this.data=e,this.index=0,Object.freeze(e.buffer)}get eof(){return this.index===this.data.length}get pos(){return this.index}get length(){return this.data.length}slice(e,t){return this.data.slice(e,t)}reset(){this.index=0}read(){let e=0,t=1,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;for(;s>0;)(0,g.vA)(!this.eof,547),e+=this.data[this.index]*t,this.index++,t*=256,s--;return e}skip(e){(0,g.vA)(e>=0,548),this.index+=e,(0,g.vA)(this.index<=this.data.length,988)}}var V,j,H,J=s(41818),X=s(27612);!function(e){e[e.BoolTrue=11]="BoolTrue",e[e.BoolFalse=12]="BoolFalse",e[e.StringEmpty=13]="StringEmpty",e[e.String8Length=14]="String8Length",e[e.String16Length=15]="String16Length",e[e.String32Length=16]="String32Length",e[e.ConstString8Id=17]="ConstString8Id",e[e.ConstString16Id=18]="ConstString16Id",e[e.ConstString32Id=19]="ConstString32Id",e[e.ConstStringDeclare=20]="ConstStringDeclare",e[e.ConstStringDeclareBig=21]="ConstStringDeclareBig",e[e.Int0=1]="Int0",e[e.UInt8=3]="UInt8",e[e.UInt16=5]="UInt16",e[e.UInt32=7]="UInt32",e[e.UInt64=9]="UInt64",e[e.Int8=2]="Int8",e[e.Int16=4]="Int16",e[e.Int32=6]="Int32",e[e.Int64=8]="Int64",e[e.BinaryEmpty=32]="BinaryEmpty",e[e.BinarySingle8=33]="BinarySingle8",e[e.BinarySingle16=34]="BinarySingle16",e[e.BinarySingle32=35]="BinarySingle32",e[e.BinarySingle64=36]="BinarySingle64"}(V||(V={})),function(e){e[e.list=49]="list",e[e.set=51]="set"}(j||(j={})),function(e){e[e.list=50]="list",e[e.set=52]="set"}(H||(H={}));const K={1:0,2:1,3:1,4:2,5:2,6:4,7:4,8:8,9:8,13:0,14:1,15:2,16:4,17:1,18:2,19:4,20:1,21:4,32:0,33:1,34:2,35:4,36:8};function Q(e,t){const s=e[t];return(0,g.vA)(void 0!==s,647),s}function Y(e){const t={};for(const[s,r]of e.iteratePairs()){t[oe(s,"keynode should be a string")]=r}return t}class Z{constructor(){}}class ee extends Z{constructor(e){super(),this.data=e}get buffer(){return this.data}get arrayBuffer(){return 0===(e=this.buffer).byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);var e}static read(e,t){const s=e.read(t),r=new Uint8Array(s);for(let o=0;o<s;o++)r[o]=e.read();return new ee(r)}}class te extends Z{constructor(e,t,s){super(),this.data=e,this.start=t,this.end=s}get buffer(){return this.data.subarray(this.start,this.end)}get arrayBuffer(){const e=this.data.byteOffset;return this.data.buffer.slice(this.start+e,this.end+e)}static read(e,t){const s=e.read(t),r=e.pos;return e.skip(s),new te(e.buffer,r,r+s)}}class se{get nodes(){return this.children}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"set";this.type=e,this.children=[]}[Symbol.iterator](){return this.children[Symbol.iterator]()}iteratePairs(){return(0,g.vA)(this.length%2===0,556),function(e){const t={next:()=>{const t=e.next();if(t.done)return{value:void 0,done:!0};const s=e.next();return(0,g.vA)(!0!==s.done,555),{value:[t.value,s.value],done:s.done}},[Symbol.iterator]:()=>t};return t}(this[Symbol.iterator]())}get length(){return this.children.length}get(e){return this.children[e]}getString(e){return oe(this.children[e],"getString should return string")}getMaybeString(e){return function(e){const t=e;if(t._stringElement)return t.content}(this.children[e])}getBlob(e){const t=this.children[e];return ne(t,"getBlob should return a blob"),t}getNode(e){const t=this.children[e];return ie(t,"getNode should return a node"),t}getNumber(e){const t=this.children[e];return ae(t,"getNumber should return a number"),t}getBool(e){const t=this.children[e];return he(t,"getBool should return a boolean"),t}addNode(e){const t=new se(e);return this.children.push(t),t}addBlob(e){this.children.push(new ee(e))}addDictionaryString(e){this.children.push({content:e,dictionary:!0,_stringElement:!0})}addString(e){this.children.push({content:e,dictionary:!1,_stringElement:!0})}addNumber(e){(0,g.vA)(Number.isInteger(e),561),(0,g.vA)(void 0!==e&&e>=0,562),this.children.push(e)}addBool(e){this.children.push(e)}static readString(e,t,s){const r=Q(K,t),o=e.read(r),n=e.pos;e.skip(o);return{dictionary:s,_stringElement:!0,startPos:n,endPos:e.pos}}load(e,t){const[s,r]=(0,A.xP)(()=>this.loadStructure(e,t)),[,o]=(0,A.xP)(()=>this.loadStrings(e,s,t));return{durationStructure:r,durationStrings:o}}loadStructure(e,t){const s=[],r=[],o=[];let n=this.children;for(;!e.eof;){const t=e.read();switch(t){case j.list:case j.set:{const e=new se(t===j.set?"set":"list");n.push(e),s.push(n),n=e.children;continue}case V.ConstStringDeclare:case V.ConstStringDeclareBig:{const s=e.read(Q(K,t)),n=se.readString(e,t,!0);r.push(n),o[s]=n;continue}case V.ConstString8Id:case V.ConstString16Id:case V.ConstString32Id:{const s=o[e.read(Q(K,t))];(0,g.vA)(void 0!==s,990),n.push(s);continue}case V.StringEmpty:case V.String8Length:case V.String16Length:case V.String32Length:{const s=se.readString(e,t,!1);r.push(s),n.push(s);continue}case V.BinaryEmpty:case V.BinarySingle8:case V.BinarySingle16:case V.BinarySingle32:case V.BinarySingle64:n.push(te.read(e,Q(K,t)));continue;case V.Int0:n.push(0);continue;case V.UInt8:case V.UInt16:case V.UInt32:case V.UInt64:case V.Int8:case V.Int16:case V.Int32:case V.Int64:n.push(e.read(Q(K,t)));continue;case V.BoolTrue:n.push(!0);continue;case V.BoolFalse:n.push(!1);continue;case H.list:case H.set:n=s.pop();continue;default:throw new Error(`Invalid code: ${t}`)}}return(0,g.vA)(n===this.children,999),r}loadStrings(e,t,s){let r=0;for(const a of t)r+=a.endPos-a.startPos+1;const o=new Uint8Array(r);r=0;const n=e.buffer;(0,g.vA)(0===n.byteOffset,1e3);for(const a of t){for(let e=a.startPos;e<a.endPos;e++)o[r]=n[e],r++;o[r]=0,r++}(0,g.vA)(r===o.length,1048);const i=(0,J.Km)(o,"utf8").split(String.fromCodePoint(0));if(i.length===t.length+1)for(let a=0;a<t.length;a++)t[a].content=i[a];else{s.sendErrorEvent({eventName:"StringParsingError"});for(const e of t)(0,g.vA)(e.content===(0,J.Km)(n.subarray(e.startPos,e.endPos),"utf8"),1002)}}}class re extends se{static load(e,t){const s=new re,r=s.load(e,t);return(0,g.vA)(e.eof,563),{builder:s,telemetryProps:r}}}function oe(e,t){const s=e;if(s._stringElement)return s.content;ce(e,"BlobCore",t)}function ne(e,t){e instanceof Z||ce(e,"BlobCore",t)}function ie(e,t){e instanceof se||ce(e,"NodeCore",t)}function ae(e,t){"number"!==typeof e&&ce(e,"Number",t)}function he(e,t){"boolean"!==typeof e&&ce(e,"Boolean",t)}function ce(e,t,s){throw new S.OI(`Buffer parsing exception: ${s}`,M.E.incorrectServerResponse,{nodeType:le(e),expectedNodeType:t,driverVersion:X.z})}function le(e){return"number"===typeof e?"Number":e instanceof Z?"BlobCore":e instanceof se?"NodeCore":"boolean"===typeof e?"Boolean":e._stringElement?"String":"UnknownType"}const de="1.0";function ue(e){ie(e,"Deltas should be of type NodeCore");const t=[],s=Y(e);ae(s.firstSequenceNumber,"Seq number should be a number"),ie(s.deltas,"Deltas should be a Node");for(let r=0;r<s.deltas.length;++r)t.push(JSON.parse(s.deltas.getString(r)));return(0,g.vA)(0===t.length||s.firstSequenceNumber.valueOf()===t[0].sequenceNumber,640),t}function pe(e){let t=0,s=0;const r={},o={blobs:{},trees:r};for(const n of e){ie(n,"tree nodes should be nodes");const e=n.length;if(e>0&&"name"===n.getMaybeString(0))switch(e){case 2:r[n.getString(1)]={blobs:{},trees:{}};continue;case 4:{const e=n.getMaybeString(2);if("children"===e){const e=pe(n.getNode(3));r[n.getString(1)]=e.snapshotTree,t+=e.slowTreeStructureCount,s+=e.treeStructureCountWithGroupId;continue}if("value"===e){o.blobs[n.getString(1)]=n.getString(3);continue}break}case 6:if("nodeType"===n.getMaybeString(2)&&"value"===n.getMaybeString(4)){o.blobs[n.getString(1)]=n.getString(5);continue}if("unreferenced"===n.getMaybeString(2)&&"children"===n.getMaybeString(4)){const e=pe(n.getNode(5));r[n.getString(1)]=e.snapshotTree,t+=e.slowTreeStructureCount,s+=e.treeStructureCountWithGroupId,(0,g.vA)(n.getBool(3),987),o.unreferenced=!0;continue}}t++;const i=Y(n);void 0!==i.unreferenced&&(he(i.unreferenced,"Unreferenced flag should be bool"),(0,g.vA)(i.unreferenced,641),o.unreferenced=!0);const a=oe(i.name,"Path name should be string");if(void 0!==i.value)o.blobs[a]=oe(i.value,"Blob value should be string");else if(void 0!==i.children){ie(i.children,"Trees should be of type NodeCore");const e=pe(i.children);if(r[a]=e.snapshotTree,void 0!==i.groupId){const e=oe(i.groupId,"groupId should be a string");r[a].groupId=e,s++}t+=e.slowTreeStructureCount,s+=e.treeStructureCountWithGroupId}else r[a]={blobs:{},trees:{}}}return{snapshotTree:o,slowTreeStructureCount:t,treeStructureCountWithGroupId:s}}function ge(e){ie(e,"Snapshot should be of type NodeCore");const t=Y(e);ie(t.treeNodes,"TreeNodes should be of type NodeCore"),ae(t.sequenceNumber,"sequenceNumber should be of type number");const{snapshotTree:s,slowTreeStructureCount:r,treeStructureCountWithGroupId:o}=pe(t.treeNodes);s.id=oe(t.id,"snapshotId should be string");return{sequenceNumber:t.sequenceNumber.valueOf(),snapshotTree:s,slowTreeStructureCount:r,treeStructureCountWithGroupId:o}}function me(e,t){const{builder:s,telemetryProps:r}=re.load(new W(e),t);(0,g.vA)(1===s.length,537);const o=Y(s.getNode(0)),n=oe(o.mrv,"minReadVersion should be string"),i=oe(o.cv,"createVersion should be string");void 0!==o.lsn&&ae(o.lsn,"lsn should be a number"),(0,g.vA)(Number.parseFloat("1.0")>=Number.parseFloat(n),527),(0,g.vA)(Number.parseFloat(i)>=Number.parseFloat("1.0"),528),(0,g.vA)(de===i,706);const[a,h]=(0,A.xP)(()=>ge(o.snapshot)),[c,l]=(0,A.xP)(()=>function(e){ie(e,"TreeBlobs should be of type NodeCore");let t=0;const s=new Map;for(const r of e)if(ie(r,"blob should be node"),4===r.length&&"id"===r.getMaybeString(0)&&"data"===r.getMaybeString(2))s.set(r.getString(1),r.getBlob(3).arrayBuffer);else{t+=1;const e=Y(r);ne(e.data,"data should be of BlobCore type");const o=oe(e.id,"blob id should be string");s.set(o,e.data.arrayBuffer)}return{blobContents:s,slowBlobStructureCount:t}}(o.blobs));return{...a,blobContents:c.blobContents,ops:void 0===o.deltas?[]:ue(o.deltas),latestSequenceNumber:o.lsn,snapshotFormatV:1,telemetryProps:{...r,durationSnapshotTree:h,durationBlobs:l,slowTreeStructureCount:a.slowTreeStructureCount,slowBlobStructureCount:c.slowBlobStructureCount,treeStructureCountWithGroupId:a.treeStructureCountWithGroupId}}}var fe=s(24217);function be(e){let t="";for(const s of Object.keys(e))if(void 0!==e[s]){t+=`${""===t?"?":"&"}${s}=${encodeURIComponent(e[s])}`}return t}var ve=s(58358),ye=s(46402);function Se(e){const t={},s={id:e.id,blobs:{},trees:{}};t[""]=s;for(const r of e.entries){const e=r.path.lastIndexOf("/"),s=r.path.slice(0,Math.max(0,e)),o=r.path.slice(e+1),n=t[s];if("tree"===r.type){const e={blobs:{},trees:{},unreferenced:r.unreferenced,groupId:r.groupId};n.trees[o]=e,t[r.path]=e}else"blob"===r.type&&(n.blobs[o]=r.id)}return s}function we(e){const t=new Map;if(e.blobs)for(const r of e.blobs)(0,g.vA)("base64"===r.encoding||void 0===r.encoding,164),t.set(r.id,(0,J.Xg)(r.content,r.encoding??"utf8"));const s=e?.trees[0].sequenceNumber;return{blobContents:t,ops:e.ops?.map(e=>e.op)??[],sequenceNumber:s,snapshotTree:Se(e.trees[0]),latestSequenceNumber:e.ops&&e.ops.length>0?e.ops[e.ops.length-1].sequenceNumber:s,snapshotFormatV:1}}var Te,Ce=s(27015);async function ke(e,t,s,r,o,i,a,h,c,l){const d=e.sharingLinkToRedeem;return d&&(e.shareLinkInfo={...e.shareLinkInfo,sharingLinkToRedeem:d}),Ee(e,t,s,o,i,a,c,l).catch(async r=>{if(l&&function(e,t){if(void 0!==e.shareLinkInfo?.sharingLinkToRedeem&&"object"===typeof t&&null!==t&&(t.errorType===M.E.authorizationError||t.errorType===M.E.fileNotFoundOrAccessDeniedError))return!0;return!1}(e,r)){await async function(e,t,s){await n.Bt.timedExecAsync(s,{eventName:"RedeemShareLink"},async()=>{(0,g.vA)(!!e.shareLinkInfo?.sharingLinkToRedeem,493);const o=function(e){let t=(0,G.O0)(encodeURI(e));return t=t.replace(/=+$/g,"").replace(/\//g,"_").replace(/\+/g,"-"),t="u!".concat(t),t}(e.shareLinkInfo?.sharingLinkToRedeem);let n;async function i(e){await(0,A.gO)(async s=>{n=`${e}/_api/v2.0/shares/${o}/driveItem`;const r=n,i="GET",a=await t({...s,request:{url:r,method:i}},"RedeemShareLink"),h=(0,ve.b)(a);h.prefer="redeemSharingLink",await(0,A.bf)(r,{headers:h,method:i})})}if(!(0,m.Ln)(s).config.getBoolean("Fluid.Driver.Odsp.DisableUsingTenantDomainForSharesApi"))try{return void await i(new URL(e.siteUrl).origin)}catch(r){s.sendTelemetryEvent({eventName:"ShareLinkRedeemFailedWithTenantDomain",details:JSON.stringify({length:n?.length,shareLinkUrlLength:e.shareLinkInfo?.sharingLinkToRedeem.length,queryParamsLength:new URL(e.shareLinkInfo?.sharingLinkToRedeem).search.length,useHeaders:!0})},r)}await i(e.siteUrl)})}(e,t,o);const h={...e,shareLinkInfo:{...e.shareLinkInfo,sharingLinkToRedeem:void 0}};return o.sendTelemetryEvent({eventName:"RedeemFallback",errorType:r.errorType},r),Ee(h,t,s,o,i,a,c)}throw r}).catch(async e=>{throw("object"===typeof e&&null!==e&&e.errorType===M.E.authorizationError||e.errorType===M.E.fileNotFoundOrAccessDeniedError)&&await h(),e})}async function Ee(e,t,s,r,o,i,a,h){return(0,A.gO)(async c=>{const l=(0,A.vh)(a),d=l?"TreesLatestForGroup":"TreesLatest",u=(0,Ce.ir)(e.siteUrl),p={eventName:d,attempts:c.refresh?2:1,shareLinkPresent:void 0!==e.shareLinkInfo?.sharingLinkToRedeem,isSummarizer:e.summarizer,redeemFallbackEnabled:h,details:{internalFarmType:u}};if(void 0!==s)for(const[e,t]of Object.entries(s))void 0!==t&&(p[`snapshotOption_${e}`]=t);return n.Bt.timedExecAsync(r,p,async n=>{let h,d;void 0!==s?.timeout&&(h=new AbortController,d=setTimeout(()=>h.abort(),s.timeout));const[u,p]=await(0,A.jL)(async()=>o(e,t,c,a,s,h)).finally(()=>{void 0!==d&&(clearTimeout(d),d=void 0)}),m=u.odspResponse,b=m.headers.get("content-type"),v={...m.propsToLog,contentType:b,accept:u.requestHeaders.accept,driverVersion:X.z};let y,w,T,C;b?.includes("application/ms-fluid")?w="application/ms-fluid":b?.includes("application/json")&&(w="application/json");try{switch(w){case"application/json":{let e,t;[e,C]=await(0,A.jL)(async()=>m.content.text().then(e=>(0===e.length&&(0,_.lJ)("Response from browser is empty",_.TX,m.content,void 0,v),e)).catch(e=>(0,_.lJ)("Error while parsing fetch response",_.TX,m.content,void 0,v))),v.bodySize=e.length,[t,T]=(0,A.xP)(()=>JSON.parse(e)),function(e){(0,g.vA)(void 0!==e.trees,512),(0,g.vA)(void 0!==e.blobs,513)}(t);const s=we(t);y={...m,content:{...s,telemetryProps:{}}};break}case"application/ms-fluid":{let e,t;if([e,C]=await(0,A.jL)(async()=>m.content.arrayBuffer().then(e=>(0===e.byteLength&&(0,_.lJ)("Response from browser is empty",_.TX,m.content,void 0,v),e)).catch(e=>(0,_.lJ)("Error while parsing fetch response",_.TX,m.content,void 0,v))),v.bodySize=e.byteLength,[t,T]=(0,A.xP)(()=>me(new Uint8Array(e),r)),void 0===t.snapshotTree.trees||void 0===t.snapshotTree.blobs)throw new S.OI("Returned odsp snapshot is malformed. No trees or blobs!",M.E.incorrectServerResponse,v);const s=t.telemetryProps,o=s.slowTreeStructureCount??0,n=s.slowBlobStructureCount??0,i=s.treeStructureCountWithGroupId??0;(o-i>10||n>10)&&r.sendErrorEvent({eventName:"SlowSnapshotParseCodePaths",slowTreeStructureCount:o,slowBlobStructureCount:n,treeStructureCountWithGroupId:i}),y={...m,content:t};break}default:throw new S.OI("Unknown snapshot content type",M.E.incorrectServerResponse,v)}}catch(L){if((0,$.X)(L))throw L.addTelemetryProperties(v),L;throw(0,z.J4)(L,e=>new S.OI(`Error parsing snapshot response: ${e}`,M.E.genericError,v))}(0,g.vA)(void 0!==y,786);const k=y.content,E="true"!==m.headers.get("disablebrowsercachingofusercontent")&&!l,N=k.sequenceNumber??0,I=k.ops&&k.ops.length>0?k.ops[0].sequenceNumber-1:void 0;if(!Number.isInteger(N)||void 0!==I&&I!==N)r.sendErrorEvent({eventName:"fetchSnapshotError",sequenceNumber:N,seqNumberFromOps:I}),k.sequenceNumber=void 0;else if(E){const e=m.headers.get("x-fluid-epoch");(0,g.vA)(void 0!==e,486);const t={value:{...k,cacheEntryTime:Date.now()},fluidEpoch:e,version:fe.F};i(t)}return n.end({...Ne(k),blobs:k.blobContents?.size??0,sequenceNumber:N,ops:k.ops?.length??0,fetchSnapshotForLoadingGroup:l,useLegacyFlowWithoutGroups:(0,A.Ss)(a),userOps:k.ops?.filter(e=>e.type===q.Operation).length??0,fetchTime:p,parseTime:T,receiveContentTime:C,...f(u.requestUrl,"fetch"),sltelemetry:m.headers.get("x-fluid-sltelemetry"),...v,...y.content.telemetryProps}),k}).catch(e=>{throw"object"!==typeof e||null===e||e.errorType!==M.E.fetchFailure&&e.errorType!==M.E.fetchTimeout||(e[A.TV]=!0),e})})}function Ne(e){const t={trees:0,leafTrees:0,blobNodes:0};Ie(e.snapshotTree,t);let s=0;for(const[r,o]of e.blobContents)s+=o.byteLength;return{...t,encodedBlobsSize:s}}function Ie(e,t){t.blobNodes+=Object.entries(e.blobs).length,t.trees++;const s=Object.entries(e.trees);if(0===s.length)t.leafTrees++;else for(const[r,o]of s)t.trees++,Ie(o,t)}!function(e){e[e.Json=0]="Json",e[e.Binary=1]="Binary",e[e.JsonAndBinary=2]="JsonAndBinary"}(Te||(Te={}));const Ae=(0,ye.p)(async(e,t,s,r,o,n,a,h,c)=>{const l=e.sharingLinkToRedeem;l&&(e.shareLinkInfo={...e.shareLinkInfo,sharingLinkToRedeem:l});const d=e.endpoints.snapshotStorageUrl,u={ump:1};if(void 0!==o)for(const[i,g]of Object.entries(o))void 0!==g&&"timeout"!==i&&(u[i]=g);void 0!==r&&(u.groupId=r.join(","));const p=`${d}/trees/latest${be(u)}`,m="POST",f=await t({...s,request:{url:p,method:m}},"downloadSnapshot");(0,g.vA)(null!==f,485);const{body:b,headers:v}=function(e,t,s){const r=(0,i.A)(),o=[];if(o.push(`--${r}`,`Authorization: ${t}`,"X-HTTP-Method-Override: GET"),void 0!==s)for(const[n,i]of Object.entries(s))void 0!==i&&o.push(`${n}: ${i}`);return e.shareLinkInfo?.sharingLinkToRedeem&&o.push(`sl: ${e.shareLinkInfo?.sharingLinkToRedeem}`),o.push("_post: 1",`\r\n--${r}--`),{body:o.join("\r\n"),headers:{"Content-Type":`multipart/form-data;boundary=${r}`}}}(e,f,{prefer:"manualredirect"}),y={body:b,headers:v,signal:a?.signal,method:m};if(n===Te.Binary)v.accept=`application/ms-fluid; v=${de}`;else v.accept=`application/json, application/ms-fluid; v=${de}`;return{odspResponse:await(h?.fetch(p,y,"treesLatest",!0,c)??(0,A.ZR)(p,y)),requestHeaders:v,requestUrl:p}});class Le{constructor(){this.deferBlobCacheClear=!1,this._blobCache=new Map,this.blobsEvicted=new Set,this.blobCacheTimeoutDuration=12e4,this.purgeEnabled=!1}get value(){return this._blobCache}addBlobs(e){for(const[t,s]of e.entries())this._blobCache.set(t,s);this.scheduleClearBlobsCache()}scheduleClearBlobsCache(){if(void 0!==this.blobCacheTimeout)this.deferBlobCacheClear=!0;else if(this.purgeEnabled){const e=()=>{if(this.blobCacheTimeout=void 0,this.deferBlobCacheClear)this.deferBlobCacheClear=!1,this.scheduleClearBlobsCache();else{for(const e of this._blobCache.keys())this.blobsEvicted.add(e);this._blobCache.clear()}};this.blobCacheTimeout=setTimeout(e,this.blobCacheTimeoutDuration),this.blobCacheTimeoutDuration=1e4}}getBlob(e){this.scheduleClearBlobsCache();return{blobContent:this._blobCache.get(e),evicted:this.blobsEvicted.has(e)}}setBlob(e,t){if(t.byteLength<262144)return this.scheduleClearBlobsCache(),this._blobCache.set(e,t);this.blobsEvicted.add(e)}}class Pe{constructor(e){this.commitCache=new Map,this.blobCache=new Le;const t=e.getBoolean("Fluid.Driver.Odsp.TestOverride.DisableSnapshotCache")?0:l.Pb;this.policies={caching:R.NoCaching,maximumCacheDurationMs:t}}set ops(e){(0,g.vA)(void 0===this._ops,165),this._ops=e}get ops(){return this._ops}get snapshotSequenceNumber(){return this._snapshotSequenceNumber}async readBlobCore(e){const{blobContent:t,evicted:s}=this.blobCache.getBlob(e);return t??this.fetchBlobFromStorage(e,s)}async readBlob(e){return this.readBlobCore(e)}async getSnapshotTree(e,t){let s;if(e?.id)s=e.id;else{const e=await this.getVersions(null,1,t);if(!e||0===e.length)return null;s=e[0].id}const r=await this.readTree(s,t);return r?this.combineProtocolAndAppSnapshotTree(r):null}async downloadSummary(e){throw new Error("Not implemented yet")}setRootTree(e,t){this.commitCache.set(e,t)}initBlobsCache(e){this.blobCache.addBlobs(e)}async readTree(e,t){let s=this.commitCache.get(e);return s||(s=await this.fetchTreeFromSnapshot(e,t)),s??null}combineProtocolAndAppSnapshotTree(e){const t=e.trees[".app"],s=e.trees[".protocol"],r={blobs:{...t.blobs},trees:{...t.trees},id:e.id};return void 0!==s&&(r.trees[".protocol"]=s),r}initializeFromSnapshot(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._snapshotSequenceNumber=e.sequenceNumber;const{snapshotTree:r,blobContents:o,ops:n}=e;let i;return r&&(i=r.id,(0,g.vA)(void 0!==i,545),s&&this.setRootTree(i,r)),void 0!==o&&this.initBlobsCache(o),t&&(this.ops=n),i}}class Re extends Pe{constructor(e,t,s,r,o,n,i,a,h,c){super((0,m.Ln)(s).config),this.odspResolvedUrl=e,this.getAuthHeader=t,this.logger=s,this.fetchFullSnapshot=r,this.cache=o,this.hostPolicy=n,this.epochTracker=i,this.flushCallback=a,this.relayServiceTenantAndSessionId=h,this.snapshotFormatFetchType=c,this.odspSummaryModuleLoaded=!1,this.firstSnapshotFetchCall=!0,this.maxSnapshotSizeLimit=5e8,this.maxSnapshotFetchTimeout=12e4,this.createBlobRateLimiter=new x.v(1),this.documentId=this.odspResolvedUrl.hashedDocumentId,this.snapshotUrl=this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.attachmentPOSTUrl=this.odspResolvedUrl.endpoints.attachmentPOSTStorageUrl,this.attachmentGETUrl=this.odspResolvedUrl.endpoints.attachmentGETStorageUrl,this.config=(0,m.Ln)(s).config}get isFirstSnapshotFromNetwork(){return this._isFirstSnapshotFromNetwork}async createBlob(e){this.checkAttachmentPOSTUrl();return(await(0,A.gO)(async t=>{const s=`${this.attachmentPOSTUrl}/content`,r="POST",o=await this.getAuthHeader({...t,request:{url:s,method:r}},"CreateBlob"),i=(0,ve.b)(o);return i["Content-Type"]="application/octet-stream",n.Bt.timedExecAsync(this.logger,{eventName:"createBlob",size:e.byteLength,waitQueueLength:this.createBlobRateLimiter.waitQueueLength},async t=>{const o=await this.createBlobRateLimiter.schedule(async()=>this.epochTracker.fetchAndParseAsJSON(s,{body:e,headers:i,method:r},"createBlob"));return t.end({blobId:o.content.id,...o.propsToLog}),o})})).content}async fetchBlobFromStorage(e,t){this.checkAttachmentGETUrl();const s=await(0,A.gO)(async s=>{const r=`${this.attachmentGETUrl}/${encodeURIComponent(e)}/content`,o=await this.getAuthHeader({...s,request:{url:r,method:"GET"}},"GetBlob"),i=(0,ve.b)(o);return n.Bt.timedExecAsync(this.logger,{eventName:"readDataBlob",blobId:e,evicted:t,waitQueueLength:this.epochTracker.rateLimiter.waitQueueLength},async t=>{const o=await this.epochTracker.fetchArray(r,{headers:i},"blob");t.end({waitQueueLength:this.epochTracker.rateLimiter.waitQueueLength,...o.propsToLog,attempts:s.refresh?2:1});const n=o.headers.get("cache-control");return void 0!==n&&(n.includes("private")||n.includes("public"))||this.logger.sendErrorEvent({eventName:"NonCacheableBlob",cacheControl:n,blobId:e,...o.propsToLog}),o.content})});return this.blobCache.setBlob(e,s),s}async getSnapshotTree(e,t){return this.snapshotUrl?super.getSnapshotTree(e,t):null}async getSnapshot(e){const{snapshot:t}=await this.fetchSnapshot({...e,fetchSource:(0,A.vh)(e?.loadingGroupIds)?B.noCache:e?.fetchSource,loadingGroupIds:e?.loadingGroupIds??[]});return{...t,snapshotTree:this.combineProtocolAndAppSnapshotTree(t.snapshotTree)}}async fetchSnapshot(e){const t=this.hostPolicy.snapshotOptions,s=await n.Bt.timedExecAsync(this.logger,{eventName:(0,A.vh)(e.loadingGroupIds)?"ObtainSnapshotForGroup":"ObtainSnapshot",fetchSource:e?.fetchSource},async s=>{const r={};let o,n,i=0,a=(0,v.l)();if(e.fetchSource===B.noCache)o=await this.fetchSnapshotFromNetwork(t,e.loadingGroupIds,e.scenarioName),n="networkOnly";else{const s=this.epochTracker.get((0,A.wL)(this.odspResolvedUrl,(0,A.JH)(this.config))).then(async e=>{if(void 0!==e){const t=Date.now()-(e.cacheEntryTime??Date.now()-2592e6);if(this.hostPolicy.summarizerClient){if(t>6e4)return void(r.cacheSummarizerExpired=!0);r.cacheSummarizerExpired=!1}if(r.cacheEntryAge=t,(0,A.IU)(e))return e;return{snapshotTree:e.snapshotTree,blobContents:e.blobs,ops:e.ops,latestSequenceNumber:e.latestSequenceNumber,sequenceNumber:e.sequenceNumber,snapshotFormatV:1}}});if(this.firstSnapshotFetchCall&&this.hostPolicy.concurrentSnapshotFetch&&!this.hostPolicy.summarizerClient){const r=this.fetchSnapshotFromNetwork(t,e.loadingGroupIds,e.scenarioName),i=await async function(e){return new Promise((t,s)=>{e.forEach((e,r)=>{e.then(e=>t({index:r,value:e})).catch(s)})})}([s.catch(()=>{}),r.catch(()=>{})]);if(o=i.value,n=0===i.index?"cache":"network",void 0===o)try{1===i.index&&(o=await s,n="cache"),void 0===o&&(o=await r,n="network")}catch(c){const e=c.stack,t=(0,z.cQ)(c);t.addTelemetryProperties({innerStack:e});const s=`<<STACK TRUNCATED: see innerStack property>> \n${(0,z.aX)()}`;throw(0,z.kc)(t,s),t}}else{const r=(0,v.l)();o=await s,i=(0,v.l)()-r,n=void 0===o?"network":"cache",void 0===o&&(a=(0,v.l)(),o=await this.fetchSnapshotFromNetwork(t,e.loadingGroupIds,e.scenarioName))}}"network"===n&&(r.cacheEntryAge=void 0),this.firstSnapshotFetchCall&&(this._isFirstSnapshotFromNetwork="cache"!==n);const h=o.prefetchStartTime;return s.end({...r,method:n,fetchSnapshotForInitialLoad:this.firstSnapshotFetchCall,useLegacyFlowWithoutGroups:(0,A.Ss)(e.loadingGroupIds),avoidPrefetchSnapshotCache:this.hostPolicy.avoidPrefetchSnapshotCache,...Ne(o),cacheLookupTimeInSerialFetch:i,prefetchSavedDuration:void 0!==h&&"cache"!==n?a-h:void 0}),o}),r=(0,v.l)(),o=this.initializeFromSnapshot(s,this.firstSnapshotFetchCall,e?.cacheSnapshot??this.firstSnapshotFetchCall);return this.logger.sendTelemetryEvent({eventName:"SnapshotInitializeTime",duration:(0,v.l)()-r},void 0,F.$.verbose),this.firstSnapshotFetchCall=!1,{snapshot:s,id:o}}async getVersions(e,t,s,r){if(e!==this.documentId&&e)return[{id:e,treeId:void 0}];if(!this.snapshotUrl)return[];if(1===t&&(null===e||e===this.documentId)){const{id:t}=await this.fetchSnapshot({cacheSnapshot:!0,scenarioName:s,versionId:e??void 0,fetchSource:r});return t?[{id:t,treeId:void 0}]:[]}return(0,A.gO)(async e=>{const r=`${this.snapshotUrl}/versions?top=${t}`,o=await this.getAuthHeader({...e,request:{url:r,method:"GET"}},"GetVersions"),i=(0,ve.b)(o),a=(await n.Bt.timedExecAsync(this.logger,{eventName:"getVersions"},async()=>this.epochTracker.fetchAndParseAsJSON(r,{headers:i},"versions",void 0,s))).content;if(!a)throw new S.OI("No response from /versions endpoint",M.E.genericNetworkError,{driverVersion:X.z});if(!Array.isArray(a.value))throw new S.OI("Incorrect response from /versions endpoint, expected an array",M.E.genericNetworkError,{driverVersion:X.z});return a.value.map(e=>({id:e.id,treeId:void 0}))})}async fetchSnapshotFromNetwork(e,t,s){return this.fetchSnapshotFromNetworkCore(e,t,s).catch(e=>{throw"object"===typeof e&&null!==e&&(e.canRetry=!1),e})}async fetchSnapshotFromNetworkCore(e,t,s){if(!this.hostPolicy.avoidPrefetchSnapshotCache&&this.firstSnapshotFetchCall){const e=(0,l.V$)((0,A.wL)(this.odspResolvedUrl,(0,A.JH)(this.config))),t=await(this.cache.snapshotPrefetchResultCache?.get(e)?.then(async t=>(this.cache.snapshotPrefetchResultCache.remove(e),await this.epochTracker.validateEpoch(t.fluidEpoch,"treesLatest"),t)).catch(async e=>{this.logger.sendTelemetryEvent({eventName:"PrefetchSnapshotError",concurrentSnapshotFetch:this.hostPolicy.concurrentSnapshotFetch},e)}));if(void 0!==t)return t}const r={mds:this.maxSnapshotSizeLimit,...e,timeout:e?.timeout?Math.min(e.timeout,this.maxSnapshotFetchTimeout):this.maxSnapshotFetchTimeout};this.hostPolicy.summarizerClient&&(r.mds=void 0,r.timeout=void 0);const o=async(e,t,r,o,n,i)=>Ae(e,t,r,o,n,this.snapshotFormatFetchType,i,this.epochTracker,s),n=async e=>this.cache.persistedCache.put((0,A.wL)(this.odspResolvedUrl,(0,A.JH)(this.config)),e.value),i=async()=>this.cache.persistedCache.removeEntries();try{return await ke(this.odspResolvedUrl,this.getAuthHeader,r,this.hostPolicy.sessionOptions,this.logger,o,n,i,t,this.hostPolicy.enableRedeemFallback)}catch(a){const s=a.errorType;if(s===M.E.snapshotTooBig&&void 0!==e?.mds&&!0!==this.hostPolicy.summarizerClient)throw a;if((s===M.E.snapshotTooBig||s===M.E.fetchTimeout)&&r.blobs){this.logger.sendErrorEvent({eventName:"TreeLatest_SecondCall",errorType:s});const e={...r,blobs:0,mds:void 0,timeout:void 0};return await ke(this.odspResolvedUrl,this.getAuthHeader,e,this.hostPolicy.sessionOptions,this.logger,o,n,i,t,this.hostPolicy.enableRedeemFallback)}throw a}}async uploadSummaryWithContext(e,t){if(this.checkSnapshotUrl(),void 0===this.summaryModuleP&&(this.summaryModuleP=this.getDelayLoadedSummaryManager()),".protocol"in e.tree&&void 0!==t.ackHandle){let e=1;for(;;){const s=await this.flushCallback(),r=s.lastPersistedSequenceNumber;if(void 0!==r&&r>=t.referenceSequenceNumber)break;if(e>3){this.logger.sendErrorEvent({eventName:"FlushFailure",...s,retry:e,referenceSequenceNumber:t.referenceSequenceNumber});break}this.logger.sendPerformanceEvent({eventName:"FlushExtraCall",...s,retry:e,referenceSequenceNumber:t.referenceSequenceNumber}),e++,await(0,O.c)(1e3*(s.retryAfter??1))}}this.odspSummaryUploadManager||(this.odspSummaryUploadManager=await this.summaryModuleP.then(async e=>(this.odspSummaryModuleLoaded=!0,e)).catch(e=>{throw this.odspSummaryModuleLoaded=!1,e})),(0,g.vA)(void 0!==this.odspSummaryUploadManager,1390);const s=await this.odspSummaryUploadManager.writeSummaryTree(e,t),{pendingRename:r}=this.odspResolvedUrl;if(void 0!==r&&!0!==this.config.getBoolean("Fluid.Driver.Odsp.disablePendingRename")){(0,g.vA)(void 0===t.ackHandle&&void 0===t.proposalHandle&&0===t.referenceSequenceNumber,2696);const e=await a(this.logger,async e=>e.renameEmptyFluidFile(this.getAuthHeader,this.odspResolvedUrl,r,this.logger,this.epochTracker));this.odspResolvedUrl.pendingRename=void 0,this.odspResolvedUrl.fileName=e.name}return s}async getDelayLoadedSummaryManager(){(0,g.vA)(!1===this.odspSummaryModuleLoaded,1391);const e=await s.e(11133).then(s.bind(s,67300)).then(e=>(this.logger.sendTelemetryEvent({eventName:"SummaryModuleLoaded"}),e)).catch(e=>{throw this.logger.sendErrorEvent({eventName:"SummaryModuleLoadFailed"},e),e});return this.odspSummaryUploadManager=new e.OdspSummaryUploadManager(this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.getAuthHeader,this.logger,this.epochTracker,this.relayServiceTenantAndSessionId),this.odspSummaryUploadManager}checkSnapshotUrl(){if(!this.snapshotUrl)throw new S.OI("Method failed because no snapshot url was available",M.E.genericError,{driverVersion:X.z})}checkAttachmentPOSTUrl(){if(!this.attachmentPOSTUrl)throw new S.OI("Method failed because no attachment POST url was available",M.E.genericError,{driverVersion:X.z})}checkAttachmentGETUrl(){if(!this.attachmentGETUrl)throw new S.OI("Method failed because no attachment GET url was available",M.E.genericError,{driverVersion:X.z})}async fetchTreeFromSnapshot(e,t){return(0,A.gO)(async s=>{const r=await async function(e,t,s,r,o,i){let a={};s&&(a="latest"===t?{deltas:1,blobs:2}:{blobs:2});const h=`${e}/trees/${t}${be(a)}`;return we((await n.Bt.timedExecAsync(o,{eventName:"fetchSnapshot"},async()=>i(h))).content)}(this.snapshotUrl,e,this.fetchFullSnapshot,this.hostPolicy.sessionOptions,this.logger,async e=>{const r=await this.getAuthHeader({...s,request:{url:e,method:"GET"}},"ReadCommit"),o=(0,ve.b)(r);return this.epochTracker.fetchAndParseAsJSON(e,{headers:o},"snapshotTree",void 0,t)});let o="";return r.snapshotTree&&((0,g.vA)(void 0!==r.snapshotTree.id,546),o=r.snapshotTree.id,this.setRootTree(o,r.snapshotTree)),r.blobContents&&this.initBlobsCache(r.blobContents),this.commitCache.get(e)??this.commitCache.get(o)})}}class Be{constructor(e,t,s,r,o,n){this.logger=t,this.cache=s,this.batchSize=r,this.timerGranularity=o,this.totalOpsToCache=n,this.batches=new Map;const i=this.batchSize-this.getPositionInBatchArray(e)-1;0!==i&&this.batches.set(this.getBatchNumber(e),{remainingSlots:i,batchData:this.initializeNewBatchDataArray(),dirty:!1})}dispose(){this.batches.clear(),void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0)}flushOps(){for(const[e,t]of this.batches)null===t||!t.dirty||0===t.batchData.length||void 0===t.batchData[0]&&void 0===t.batchData[t.batchData.length-1]||(t.dirty=!1,this.write(e,t))}addOps(e){if(!(this.totalOpsToCache<=0))for(const t of e){const e=this.getBatchNumber(t.sequenceNumber),s=this.getPositionInBatchArray(t.sequenceNumber);let r=this.batches.get(e);if(void 0===r)r={remainingSlots:this.batchSize-1,batchData:this.initializeNewBatchDataArray(),dirty:!0},r.batchData[s]=t,this.batches.set(e,r);else{if(null===r||void 0!==r.batchData[s])return;r.batchData[s]=t,r.remainingSlots--,r.dirty=!0}if(0===r.remainingSlots?(this.write(e,r),this.batches.set(e,null)):this.scheduleTimer(),this.totalOpsToCache--,0===this.totalOpsToCache){this.logger.sendPerformanceEvent({eventName:"CacheOpsLimitHit"}),this.cache.remove(),this.dispose();break}}}async getCore(e,t){const s=[];let r=this.getBatchNumber(e);for(;;){const o=await this.cache.read(`${this.batchSize}_${r}`);if(void 0===o)return s;const n=JSON.parse(o),i=s.length;for(const r of n)if(r){if(void 0!==t&&r.sequenceNumber>=t)return s;if(0===s.length){if(r.sequenceNumber>e)return s;if(r.sequenceNumber<e)continue}s.push(r)}else if(s.length>0)return s;if(i===s.length)return s;r++}}async get(e,t){const s=(0,v.l)(),r=await this.getCore(e,t),o=(0,v.l)()-s;return(r.length>0||o>1e3)&&this.logger.sendPerformanceEvent({eventName:"CacheOpsUsed",from:e,to:t,length:r.length,duration:o}),r}write(e,t){this.cache.write(`${this.batchSize}_${e}`,JSON.stringify(t.batchData)).catch(()=>{this.totalOpsToCache=0})}scheduleTimer(){!this.timer&&this.timerGranularity>0&&(this.timer=setTimeout(()=>{this.timer=void 0,this.flushOps()},this.timerGranularity))}getBatchNumber(e){return Math.floor(e/this.batchSize)}getPositionInBatchArray(e){return e%this.batchSize}initializeNewBatchDataArray(){const e=[];return e.length=this.batchSize,e}}var Fe=s(34023);z.iq;class Oe extends z.iq{constructor(e,t){super(e,{...t,usageError:!0}),this.errorType=Fe.k.usageError}}z.iq;z.iq;var qe=s(62951);class Ue{constructor(e,t){this.internalStorageService=e,this.logger=t,this._disposed=!1}get policies(){return this.internalStorageService.policies}get disposed(){return this._disposed}dispose(){this._disposed=!0}async getSnapshotTree(e){return this.runWithRetry(async()=>this.internalStorageService.getSnapshotTree(e),"storage_getSnapshotTree")}async getSnapshot(e){return this.runWithRetry(async()=>{if(void 0!==this.internalStorageService.getSnapshot)return this.internalStorageService.getSnapshot(e);throw new Oe("getSnapshot should exist in storage adapter in ODSP driver")},"storage_getSnapshot")}async readBlob(e){return this.runWithRetry(async()=>this.internalStorageService.readBlob(e),"storage_readBlob")}async getVersions(e,t,s,r){return this.runWithRetry(async()=>this.internalStorageService.getVersions(e,t,s,r),"storage_getVersions")}async uploadSummaryWithContext(e,t){return this.runWithRetry(async()=>this.internalStorageService.uploadSummaryWithContext(e,t),"storage_uploadSummaryWithContext")}async downloadSummary(e){return this.runWithRetry(async()=>this.internalStorageService.downloadSummary(e),"storage_downloadSummary")}async createBlob(e){return this.runWithRetry(async()=>this.internalStorageService.createBlob(e),"storage_createBlob")}checkStorageDisposed(){if(this._disposed)throw new z.iq("Storage Service is disposed. Cannot retry",{canRetry:!1})}async runWithRetry(e,t){return(0,qe.M)(e,t,this.logger,()=>this.checkStorageDisposed())}}class De extends p.X{static async create(e,t,s,r,o,n,i,a,h){return new De((0,A.Yn)(e),t,s,r,o,n,i,a,h)}constructor(e,t,s,r,o,n,i,a,h){super(),this.odspResolvedUrl=e,this.getAuthHeader=t,this.getWebsocketToken=s,this.cache=o,this.epochTracker=i,this.socketReferenceKeyPrefix=a,this.clientIsSummarizer=h,this.odspSocketModuleLoaded=!1,this._policies={storageOnly:void 0!==e.fileVersion,summarizeProtocolTree:!0,supportGetSnapshotApi:!0},this.mc=(0,m.CL)({logger:r,properties:{all:{odc:(0,Ce.je)(new URL(this.odspResolvedUrl.endpoints.snapshotStorageUrl))}}}),this.hostPolicy=n,this.hostPolicy.supportGetSnapshotApi=this._policies.supportGetSnapshotApi,this.clientIsSummarizer&&(this.hostPolicy={...this.hostPolicy,summarizerClient:!0})}get resolvedUrl(){return this.odspResolvedUrl}get policies(){return this._policies}async connectToStorage(){return this.storageManager||(this.storageManager=new Re(this.odspResolvedUrl,this.getAuthHeader,this.mc.logger,!0,this.cache,this.hostPolicy,this.epochTracker,async()=>{const e=this.odspDelayLoadedDeltaStream?.currentDeltaConnection;if(void 0!==e&&!e.disposed)return e.flush();throw new Error("Disconnected while uploading summary (attempt to perform flush())")},()=>this.odspDelayLoadedDeltaStream?.relayServiceTenantAndSessionId,this.mc.config.getNumber("Fluid.Driver.Odsp.snapshotFormatFetchType"))),new Ue(this.storageManager,this.mc.logger)}async connectToDeltaStorage(){const e=this.storageManager?.ops??[],t=new L(this.odspResolvedUrl.endpoints.deltaStorageUrl,this.getAuthHeader,this.epochTracker,this.mc.logger),s=this.hostPolicy.opsBatchSize??5e3,r=this.hostPolicy.concurrentOpsBatches??1;return new P(e,this.mc.logger,s,r,async(e,s,r,o)=>t.get(e,s,r,o),async(e,t)=>await(this.opsCache?.get(e,t))??[],(e,t)=>{const s=this.odspDelayLoadedDeltaStream?.currentDeltaConnection;void 0===s||s.disposed||s.requestOps(e,t)},e=>this.opsReceived(e),()=>this.storageManager)}async connectToDeltaStream(e){return void 0===this.socketModuleP&&(this.socketModuleP=this.getDelayLoadedDeltaStream()),this.socketModuleP.then(async t=>(this.odspSocketModuleLoaded=!0,t.connectToDeltaStream(e))).catch(e=>{throw this.socketModuleP=void 0,this.odspSocketModuleLoaded=!1,e})}async getDelayLoadedDeltaStream(){(0,g.vA)(!1===this.odspSocketModuleLoaded,1287);const e=await s.e(12956).then(s.bind(s,92024)).then(e=>(this.mc.logger.sendTelemetryEvent({eventName:"SocketModuleLoaded"}),e)).catch(e=>{throw this.mc.logger.sendErrorEvent({eventName:"SocketModuleLoadFailed"},e),e});return this.odspDelayLoadedDeltaStream=new e.OdspDelayLoadedDeltaStream(this.odspResolvedUrl,this._policies,this.getAuthHeader,this.getWebsocketToken,this.mc,this.cache,this.hostPolicy,this.epochTracker,e=>this.opsReceived(e),e=>this.emit("metadataUpdate",e),this.socketReferenceKeyPrefix),this.odspDelayLoadedDeltaStream}dispose(e){void 0===e?this._opsCache?.flushOps():this.epochTracker.removeEntries().catch(()=>{}),this._opsCache?.dispose(),this.odspDelayLoadedDeltaStream?.dispose()}get opsCache(){if(this._opsCache)return this._opsCache;const e=this.storageManager?.snapshotSequenceNumber,t=this.hostPolicy.opsCaching?.batchSize??100;if(void 0===e||t<1)return;const s={type:"ops"};return this._opsCache=new Be(e,this.mc.logger,{write:async(e,t)=>this.cache.persistedCache.put({...s,key:e},t),read:async e=>this.cache.persistedCache.get({...s,key:e}),remove:()=>{this.cache.persistedCache.removeEntries().catch(()=>{})}},t,this.hostPolicy.opsCaching?.timerGranularity??5e3,this.hostPolicy.opsCaching?.totalOpsToCache??5e3),this._opsCache}opsReceived(e){0===e.length||this.odspResolvedUrl.summarizer||this.opsCache?.addOps(e)}}class xe{get snapshotPrefetchResultCache(){return this.nonPersistentCache.snapshotPrefetchResultCache}get IRelaySessionAwareDriverFactory(){return this}async getRelayServiceSessionInfo(e){const t=(0,A.Yn)(e),s=await this.nonPersistentCache.sessionJoinCache.get((0,A.Q1)(t));return s?.joinSessionResponse}async createContainer(e,t,s,i){const c=(0,A.Yn)(t),l={siteUrl:c.siteUrl,driveId:c.driveId,itemId:c.itemId};let d,u;if(c.itemId)d={type:"Existing",driveId:c.driveId,siteUrl:c.siteUrl,itemId:c.itemId};else{if(!c.fileName)throw new Error("A new or existing file must be specified to create container!");{const[,e]=c.url.split("?"),t=new URLSearchParams(e),s=t.get("path");if(void 0===s||null===s)throw new Error("File path should be provided!!");u=function(e,t){let s;if(e.enableSingleRequestForShareLinkWithCreate){const e=t.get("createLinkScope"),r=t.get("createLinkRole");e&&o.V[e]&&(s={scope:o.V[e],...r&&o.N[r]?{role:o.N[r]}:{}})}return s}(this.hostPolicy,t),d={type:"New",driveId:c.driveId,siteUrl:c.siteUrl,filePath:s,filename:c.fileName,createLinkType:u}}}if((0,r.ub)(e)){const t=(0,r.YG)(e.tree[".protocol"]);if(0!==t?.sequenceNumber)throw new Error("Seq number in detached ODSP container should be 0")}const p=(0,A.bP)(s),g={resolvedUrl:c,docId:c.hashedDocumentId},m=(0,h.iJ)(this.persistedCache,this.nonPersistentCache,g,p,i);return n.Bt.timedExecAsync(p,{eventName:"CreateNew",isWithSummaryUpload:!0,createShareLinkParam:u?JSON.stringify(u):void 0,enableSingleRequestForShareLinkWithCreate:this.hostPolicy.enableSingleRequestForShareLinkWithCreate},async t=>{const s=(0,A.bJ)(p,l,this.getStorageToken),r=await a(p,async t=>(0,A.$o)(d)?t.createNewFluidFile(s,d,p,e,m.epochTracker,g,this.hostPolicy.cacheCreateNewSummary??!0,!!this.hostPolicy.sessionOptions?.forceAccessTokenViaAuthorizationHeader,c.isClpCompliantApp,this.hostPolicy.enableSingleRequestForShareLinkWithCreate,c):t.createNewContainerOnExistingFile(s,d,p,e,m.epochTracker,g,this.hostPolicy.cacheCreateNewSummary??!0,!!this.hostPolicy.sessionOptions?.forceAccessTokenViaAuthorizationHeader,c.isClpCompliantApp)),o=this.createDocumentServiceCore(r,p,m,i);return t.end({docId:r.hashedDocumentId}),o})}constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new d,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.getStorageToken=e,this.getWebsocketToken=t,this.persistedCache=s,this.hostPolicy=r,this.nonPersistentCache=new u,!0===this.hostPolicy.isolateSocketCache&&(this.socketReferenceKeyPrefix=(0,i.A)()),this.hostPolicy.enableRedeemFallback=this.hostPolicy.enableRedeemFallback??!0,this.hostPolicy.sessionOptions={forceAccessTokenViaAuthorizationHeader:!0,...this.hostPolicy.sessionOptions}}async createDocumentService(e,t,s){return this.createDocumentServiceCore(e,(0,A.bP)(t),void 0,s)}async createDocumentServiceCore(e,t,s,r){const o=(0,n.pW)({logger:t}),i=(0,A.Yn)(e),a={siteUrl:i.siteUrl,driveId:i.driveId,itemId:i.itemId},c=s??(0,h.iJ)(this.persistedCache,this.nonPersistentCache,{resolvedUrl:i,docId:i.hashedDocumentId},o,r),l=(0,A.bJ)(o,a,this.getStorageToken),d=void 0===this.getWebsocketToken?void 0:async e=>(0,A.yI)(o,a,this.getWebsocketToken,!1,!0)(e,"GetWebsocketToken");return De.create(e,l,d,o,c.cache,this.hostPolicy,c.epochTracker,this.socketReferenceKeyPrefix,r)}}class Me extends xe{constructor(e,t,s,r){super(e,t,s,r)}}var ze=s(25969),Ge=s(14836);const _e=["https://pushchannel.1drv.ms/pushchannel.readwrite.all"];function $e(){return _e}function We(e,t,s,r,o){const n={...r};!1!==n.concurrentSnapshotFetch&&(n.concurrentSnapshotFetch=!0);return new Me(Ve(s=>e.getToken((0,ze.K)(s.siteUrl),(0,Ge.r)(s,t))),e.identityType&&["Consumer","UnauthenticatedGuest"].includes(e.identityType)?void 0:Ve(s=>e.getToken($e(),(0,Ge.r)(s,t))),s,n)}function Ve(e){return function(){return e(...arguments).then(e=>e||null)}}var je=s(29967);function He(e,t,s,r,o,n,i){return{documentServiceFactory:We(e,t,s,r),urlResolver:(0,je.o)(e,t,o,i)}}},30636:(e,t,s)=>{var r,o;s.d(t,{N:()=>o,V:()=>r}),function(e){e.organization="organization",e.users="users",e.anonymous="anonymous",e.default="default"}(r||(r={})),function(e){e.view="view",e.edit="edit"}(o||(o={}))},34904:(e,t,s)=>{s.d(t,{YG:()=>n,ub:()=>o});var r=s(84693);function o(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),o=1;o<t;o++)s[o-1]=arguments[o];if(void 0===e?.tree||e.tree?.[".app"]?.type!==r.Z.Tree||e.tree?.[".protocol"]?.type!==r.Z.Tree)return!1;return 2===Object.keys(e.tree).filter(e=>!s.includes(e)).length}function n(e){const t=e.tree.attributes;return JSON.parse(t.content)}},48101:(e,t,s)=>{t.b=void 0;var r=s(87987);Object.defineProperty(t,"b",{enumerable:!0,get:function(){return r.EventEmitter}})},84693:(e,t,s)=>{var r;s.d(t,{Z:()=>r}),function(e){e.Tree=1,e.Blob=2,e.Handle=3,e.Attachment=4}(r||(r={}))},88826:(e,t,s)=>{s.d(t,{X:()=>o});var r=s(48101);class o extends r.b{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}}}]);
//# sourceMappingURL=5899.2632c76d.chunk.js.map