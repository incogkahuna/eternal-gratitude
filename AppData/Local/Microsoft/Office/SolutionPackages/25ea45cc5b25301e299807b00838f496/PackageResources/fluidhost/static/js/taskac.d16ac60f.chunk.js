"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[41380],{9821:(e,t,s)=>{s.d(t,{B:()=>n});var a=s(12358),r=s.n(a),i=s(34167),n=function(){function e(){}return e.copyToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();var s=document.execCommand("copy");return document.body.removeChild(t),s},e.copyPrettifiedLinkToClipboard=function(e,t){var s=document.createElement("a");s.href=t,s.style.all="initial",s.innerText=e,document.body.appendChild(s);var a=document.createRange();a.selectNode(s);var n=window.getSelection();null===n||void 0===n||n.removeAllRanges(),null===n||void 0===n||n.addRange(a),s.oncopy=function(s){var a,n,o="<a href="+t+' style="all: initial;">'+r()(e)+"</a>";null===(a=s.clipboardData)||void 0===a||a.setData("text/plain",t);var l=new i.tR;l.inputString=o,null===(n=s.clipboardData)||void 0===n||n.setData("text/html",i.xC.sanitize(l)),s.preventDefault()};var o=document.execCommand("copy");return document.body.removeChild(s),o},e}()},12891:(e,t,s)=>{s.r(t),s.d(t,{TaskActionCreator:()=>Ze});var a=s(23835),r=s(7574),i=s(27197),n=s(24367),o=s(75992);class l extends o.r{constructor(e,t,s){super(e),this.actionId=t,this.inverseCallback=s}}class c extends l{loggingData(){return{id:this.deletedTaskEntitySet.id}}constructor(e,t){super(c.actionType,c.actionType+e.id,t),this.deletedTaskEntitySet=e}}c.actionType="PLW_DELETE_TASK_UNDO";class d extends o.r{constructor(e){super(d.undoAction),this.actionId=e}}d.undoAction="UNDO_ACTION";var u=s(32084),g=s(72438),h=s(36591),p=s(38752),k=s(95783),m=s(74844),T=s(78332),f=s(64226),y=s(96891),v=s(27916),S=s(23918),w=s(14983),F=s(91675),P=s(16698),C=s(98990),I=s.n(C),D=s(55491),b=s.n(D),A=s(69108),M=s.n(A),E=function(){function e(){this.taskAttachmentType=w.Er.Other,this.specificType=null,this.videoUrlParseResult={canPlay:!1,embedUrl:"",provider:"Unknown"}}return e.prototype.build=function(){return new x(this)},e.prototype.fromDriveItem=function(e,t){return this.taskAttachmentType=t.fileType,this.taskAttachmentType===w.Er.Other&&e&&(this.specificType=this.getSpecificType(e),this.videoUrlParseResult=P.W.TryParseVideoUrl(e)),this},e.prototype.fromFileName=function(e){var t=w.Er.Other,s=null,a=e.lastIndexOf(".");if(a>-1){var r=e.slice(a+1).toLowerCase();b()(F.t,function(e,s){I()(e,function(e){return e.toLowerCase()===r})&&(t=x.getTaskAttachmentTypeFromString(s))}),M()(w.ig,r)>=0&&(s=r)}return this.specificType=s,this.taskAttachmentType=t,this},e.prototype.withPropertyBag=function(e){return this.taskAttachmentType=e.taskAttachmentType||this.taskAttachmentType,this.specificType=e.specificType||this.specificType,this.taskAttachmentType===w.Er.Other&&e.url&&(null==this.specificType&&(this.specificType=this.getSpecificType(e.url)),this.videoUrlParseResult=P.W.TryParseVideoUrl(e.url)),this},e.prototype.ofDriveItemType=function(e){return this.taskAttachmentType=e,this},e.prototype.getSpecificType=function(e){var t=e.slice((e.lastIndexOf(".")-1>>>0)+2).split(/\#|\?|\&|\s/g);return t.length>0&&M()(w.ig,t[0].toLowerCase())>=0?t[0]:null},e}(),x=function(){function e(e){this.taskAttachmentType=e.taskAttachmentType,this.specificType=e.specificType,this.videoUrlParseResult=e.videoUrlParseResult}return Object.defineProperty(e,"builder",{get:function(){return new E},enumerable:!1,configurable:!0}),e.getTaskAttachmentTypeFromString=function(e){return w.Er[e]?w.Er[e]:w.Er.Other},e}(),B=s(65818),O=s(94772),L=s(95952),U=s(91181),R=s(87952),H=s(82025),N=s(18647),G=s(60653),j=s(71964),$=s(52274),W=s(80708),V=s(39589),_=s(23312),q=s(40468),X=s(8403),Y=s(56128),Z=s(34717),K=s(32561),z=s(97139),J=s(64696),Q=s(17776),ee=s(62687),te=s(70252),se=s(34648),ae=s(30275),re=s(26566),ie=s(97498);const ne=s.p+"static/media/wl_completion_sound.13a69e47a3545eb5ac81.mp3";var oe=s(56434),le=s.n(oe),ce=s(50723),de=s.n(ce),ue=s(40840),ge=s.n(ue),he=s(54320),pe=s.n(he),ke=s(19853),me=s.n(ke),Te=s(56641),fe=s.n(Te),ye=s(10871),ve=s.n(ye),Se=s(28673),we=s.n(Se),Fe=s(92394),Pe=s.n(Fe),Ce=s(56707),Ie=s.n(Ce),De=s(9821),be=s(79537),Ae=s(88880),Me=s(86053),Ee=s(80347),xe=s(9962),Be=s(39156),Oe=s(98424),Le=s(91246),Ue=s(33268),Re=s(70776),He=s(67271),Ne=s(7670),Ge=s(98502),je=s(49728),$e=s(82841);const We=16,Ve="$%@#";function _e(e){const t=function(e){try{const t=function(e){return t=atob(e.replace(/ /g,"")),t.split("").map(e=>e.charCodeAt(0));var t}(e=e.replace(/_/g,"/").replace(/-/g,"+")),s=qe(t.slice(0,We)),a=qe(t.slice(We,32));let r=function(e,t){if(null===e||void 0===e||0===e.length)return e;let s=e.length;for(;--s>=0&&!(t.indexOf(e.charAt(s))<0););return e.substr(0,s+1)}(function(e){let t="";for(let s=0;s<e.length;++s)t+=String.fromCharCode(e[s]);return t}(t.slice(32)),".");const i={},n=r.split(Ve);if(n.length>1){r=n[0];for(let e=1;e<n.length;e++){const t=n[e].split("=");t&&2===t.length&&(i[t[0]]=t[1])}}return{orgId:s,ownerId:a,tableId:r,moreInfo:i}}catch(t){return{orgId:null,ownerId:null,tableId:null,moreInfo:null}}}(e);let s=!1,a="0";return t.moreInfo&&("g"===t.moreInfo.t&&(s=!0),t.moreInfo.c&&(a=t.moreInfo.c)),{orgId:t.orgId,ownerId:t.ownerId,tableId:t.tableId,isGroupOwner:s,containerId:a}}function qe(e){if(16!==e.length)return"";let t=function(e){let t="",s="";for(let a=0;a<e.length;a++)s=e[a].toString(16),s=1===s.length?"0"+s:s,t+=s;return t}([].concat(e.slice(0,4).reverse(),e.slice(4,6).reverse(),e.slice(6,8).reverse(),e.slice(8)));return t=t.slice(0,8)+"-"+t.slice(8,12)+"-"+t.slice(12,16)+"-"+t.slice(16,20)+"-"+t.slice(20),t}var Xe=s(45795),Ye=s(21382);class Ze extends h.C{get name(){return y.M.TaskActionCreator}async addFormResponseToTask(e,t,s){const a=this.entityStoreSet.taskStore.getTaskDetails(e);if(null==a||null===t)return;const r=le()(a.forms);r[s]=a.forms[s].setProperty("formResponse",t);const i=a.setProperty("forms",r);this.updateTaskDetails(a,i)}async fetchTasksForPlan(e,t,s){const a=await this.logicModuleProviders.planModule(),r=await this.logicModuleProviders.notificationModule();a.fetchPlanAsync(e).then(async()=>{(await this.logicModuleProviders.taskModule()).fetchPlanTasksAsync(e,t).then(async e=>{if(!s)return;const t=[];e.data.Results.forEach(e=>{e.task.getReferencedUserIds().forEach(e=>{-1===t.indexOf(e)&&t.push(e)})});(await this.logicModuleProviders.userModule()).fetchUsersAsync(t)},t=>{r.handleRequestFailures(t,[k.t3.Forbidden],[k.t3.NotFound],f.fc.GetTasksForPlanError,e)})},t=>{r.handleRequestFailures(t,[k.t3.Forbidden],[k.t3.NotFound],f.fc.GetPlanError,e)})}async fetchTaskEntityGroup(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const r=await this.logicModuleProviders.taskModule(),n=await this.logicModuleProviders.notificationModule();r.fetchTaskAsync(e,t).then(async e=>{(await this.logicModuleProviders.userModule()).fetchUsersAsync(e.task.getReferencedUserIds()).catch(()=>{});const t=e.taskDetails;null!=t&&this.fetchPlanAndContainerBasedDependenciesForTask(e.task,t)}).catch(t=>{if(!(t.error instanceof $.U)&&!s){const s=t.response?.status,r=t.response?.statusText;if(s===k.t3.NotFound){const t=this.entityStoreSet.taskStore.getTask(e);t?(this.dispatcher.dispatchAction(new i.o(W.F.builder.withTask(t).build(),!0)),this.dispatcher.dispatchAction(new a.i(f.fc.TaskNotFoundError,s,r,e,[t.title],void 0,r))):this.dispatcher.dispatchAction(new a.i(f.fc.UnknownTaskNotFoundError,s,r,e,void 0,void 0,r))}else n.handleRequestFailures(t,[],[k.t3.Forbidden],f.fc.GetTaskDetailsError,e)}})}fetchReferencePreviewForTask(e){const t=this.entityStoreSet.taskStore.getTask(e),s=this.entityStoreSet.taskStore.getTaskDetails(e);if(t?.hasPreview()&&null!=s){const e=s?.getTaskPreviewReference()??null;null!=e&&this.ensureTaskReferencePreviewThumbnail(s,e)}}async fetchFormResponseForTask(e,t){let s=null;try{const a=await this.logicModuleProviders.driveItemModule(),r=await a.fetchFormResponse(e,t);if(({ownerId:s}=_e(r.formId)),!s)return void this.loggers.traceLogger.logTrace(507573833,m.k.Error,`fetchFormResponseForTask - ownerId is null [TaskId=${e}][FormId=${t}]`);const i=await this.logicModuleProviders.containerModule(),n=await i.fetchContainer({externalId:s??"",containerType:B.K.Group},!0);if(!n.unifiedGroupDetails)return void this.loggers.traceLogger.logTrace(507576733,m.k.Error,`fetchFormResponseForTask - unifiedGroupDetails is null [TaskId=${e}][FormId=${t}][GroupId=${n.unifiedGroup.id}]`);a.fetchTaskFormResponseThumbnails(r,n.unifiedGroupDetails)}catch(a){const r=a;this.loggers.traceLogger.logTrace(507576732,m.k.Error,`fetchFormResponseForTask - Failed [TaskId=${e}][FormId=${t}][GroupId=${s}] ${(0,$e.s8)(r)}`)}}fetchApprovalDetailsForTask(e){this.fetchApprovalDetailsForTaskAsync(e).catch(()=>{})}createTask(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.createTaskAsync(e,void 0,t).catch(()=>{})}createApproval(e,t){this.createApprovalAsync(e,t).catch(()=>{})}copyTask(e,t){this.copyTaskAsync(e,t).catch(e=>{this.loggers.traceLogger.logTrace(507639451,m.k.Error,`Error copying task ${(0,$e.LB)(e)}`)})}async copyLinkToTask(e){const t=this.entityStoreSet.taskStore.getTask(e);if(this.loggers.usageLogger.logData(this.name,y.M.TaskLinkCopied,{taskCreationSourceType:t?.taskCreationSourceType??""}),null!=this.shareDeepLinkCallback)this.shareDeepLinkCallback(e);else if(null==t)this.loggers.traceLogger.logTrace(507880145,m.k.Error,`copyLinkToTask - task not in store [TaskId=${e}]`);else{const s=await this.logicModuleProviders.linksModule().catch(()=>null);if(!s)return void this.loggers.traceLogger.logTrace(507531868,m.k.Error,"copyLinkToTask - failed to get LinksModule");let a=s.generateDeepLink(t.planId,e);if(a||(a=Ue.wS.generateEntityLink(t,f._n.TaskLink,f.rl.Link,new Date)),a){const s=Ye.G(Me.p.Strings.Common_PrefixForSmartUrl,Me.p.Strings.SharedComponents_PlannerAppShortTitle,t.title);if(De.B.copyPrettifiedLinkToClipboard(s,a)){const s=new L.N(e,t.title,a);this.dispatcher.dispatchAction(new n.Z(s))}}else this.loggers.traceLogger.logTrace(507561547,m.k.Error,"copyLinkToTask - generated taskLink is null")}}async moveTask(e,t){const s=this.entityStoreSet.taskStore.getTask(e),a=await this.logicModuleProviders.notificationModule();if(null==s)return void a.showErrorInternal(f.fc.MoveTaskError,void 0,void 0,t.plan.id);const r=W.F.builder.withTask(s).withFormatData(this.entityStoreSet.taskStore.getTaskboardTaskFormatting(s.id)||void 0).build();(await this.logicModuleProviders.planModule()).fetchPlanAsync(t.plan.id,!0).then(a=>{this.ensureBucket(t.bucketId,t.plan.id).then(async i=>{t={...t,bucketId:i?i.id:null};const n=await this.logicModuleProviders.taskModule();n.fetchTaskAsync(e).then(()=>{n.fetchPlanTasksAsync(t.plan.id).then(()=>{const e={bucketId:i?i.id:null,plan:t.plan,moveToDifferentContainer:t.moveToDifferentContainer};let n,o,l,c=s.getCloneForMove(e);const d=this.entityStoreSet.viewStore.getCurrentTaskGroupingState(ee.t.Plan);switch(d){case T.Yc.Progress:n=this.calculateProgressFormattingForCopyOrMove(s,r.taskFormatData,c);break;case T.Yc.Assignee:o=this.calculateAssignedToFormattingForCopyOrMove(s,r.taskFormatData,c);break;case T.Yc.Bucket:l=this.calculateBucketFormattingForCopyOrMove(s,r.taskFormatData,c);break;case T.Yc.Plan:if(!this.entityStoreSet.appContextStore.getFlights().EnableFixedSortForAtmViews){const e=this.calculateAssigneePriorityForCopyOrMove(s,c);c=c.setProperty("assigneePriority",e)}break;case T.Yc.DueDate:case T.Yc.Category:case T.Yc.Priority:case T.Yc.None:break;default:return void be.f.unreachableCase(d,e=>{this.loggers.traceLogger.logTrace(507880144,m.k.Error,e)})}const u=V._.builder.withPropertyBag({assignedBoardFormat:o,bucketBoardFormat:l,progressBoardFormat:n}).build(),g=r.getCloneForMove(e,u);this.logMoveTask(s,a,t),this.updateTask(W.F.builder.withTask(s).build(),g)})})})},e=>{this.loggers.traceLogger.logTrace(507639450,m.k.Error,`Error loading plan for move task ${(0,$e.LB)(e)}`),a.showErrorInternal(f.fc.MoveTaskError,void 0,void 0,t.plan.id)})}assignTask(e){const{userId:t,originalTask:s,updatedTask:a,elementToFocusOnDismiss:r,onAssignSuccess:i}=e,{planStore:n,userStore:o,taskStore:l,permissionsStore:c,containerStore:d,appContextStore:u}=this.entityStoreSet,h=s.planId,p=n.getPlan(h);if(null==p)return void this.loggers.traceLogger.logTrace(507880143,m.k.Error,`assignTask - plan not in store [planId=${h}]`);const k={planId:h,assigneeId:t},T=e;let f;if(!0===e.addNewMember)f=this.addNewMembersToContainer([t],p.container);else if(!0===T.shareFile){if(null==T.vroomId)return;f=this.shareDriveItem(T.vroomId,[t])}const v=n.getContainerIdForPlan(h)??"",S=(o.getContainerUsers(v)??[]).map(e=>e.id),w=d.getContainer(v),F=S.indexOf(t)>-1,P=t===u.getCurrentUserId(),C=w&&c.getContainerPermissions(w),I=C?.canViewMembers;if(null!=f||P||I&&F||(()=>{const e=l.getTasksForPlan(h)??[];return!!(0,je.bN)(e)[t]})()){i?.(),this.loggers.usageLogger.logData(this.name,y.M.AssignTaskSuccessful,k);if(Le.o.isPlexTempId(s.id))return void f?.catch(()=>{});const e=W.F.builder.withTask(s).build(),t=W.F.builder.withTask(a).build();return void this.updateTaskAsync(e,t,void 0,f).catch(()=>{})}const D=c.canAccessPlanViaSharedContainers(p.sharedWithContainers);return I&&!F?(this.dispatcher.dispatchAction(new g.o({dialogType:ie.h.AssignTaskWarning,userId:t,taskId:s.id,planId:h,assignerHasSharedContainerAccess:D,elementToFocusOnDismiss:r,onAssignSuccess:i})),void this.loggers.usageLogger.logData(this.name,y.M.AssignTaskBlockedByAddNonMember,k)):D?(this.dispatcher.dispatchAction(new g.o({dialogType:ie.h.ShareFileWarning,userId:t,taskId:s.id,planId:h,elementToFocusOnDismiss:r,onAssignSuccess:i})),void this.loggers.usageLogger.logData(this.name,y.M.AssignTaskBlockedByShareFile,k)):void 0}deleteTask(e,t){this.deleteTaskAsync(e,t).catch(()=>{})}deleteTaskSeries(e){this.deleteTaskSeriesAsync(e).catch(()=>{})}cancelApproval(e){this.cancelApprovalAsync(e).catch(()=>{})}updateApprovalStatus(e,t,s){this.updateApprovalStatusAsync(e,t,s).catch(()=>{})}async undeleteTask(e){const t=await this.logicModuleProviders.taskModule(),s=await this.logicModuleProviders.notificationModule();t.undeleteTaskAsync(e).then(e=>{const t=Ue.wS.generateEntityLink(e.task,f._n.TaskLink,f.rl.Link,new Date);this.dispatcher.dispatchAction(new n.Z(new j.f(e.task.title,t)))},t=>{if(!(t.error instanceof $.U)){const a=t.response?.status,r=t.response?.statusText,i=t.error?.name;i===v.Zg?s.showInfoInternal(f.fc.PlanConvertingInfo):s.showErrorInternal(f.fc.UndeleteTaskError,a,r,e.id,t.response,[e.task.title])}})}updateTask(e,t){this.updateTaskAsync(e,t).catch(()=>{})}updateTaskDetails(e,t){this.updateTaskDetailsInternal(e,t).catch(()=>{})}ensureTaskReferencePreviewThumbnail(e,t){null!=this.entityStoreSet.taskStore.getTask(e.id)?this.fetchTaskContainer(e.id).then(async s=>{if(s.containerType!==B.K.Group)return;const a=s;if(a.unifiedGroupDetails){(await this.logicModuleProviders.driveItemModule()).fetchTaskReferenceThumbnails(e,a.unifiedGroupDetails,[t])}}).catch(e=>{this.loggers.traceLogger.logTrace(507880141,m.k.Warning,`ensureTaskReferencePreviewThumbnail - fetchTaskContainer Failed ${(0,$e.s8)(e)}`)}):this.loggers.traceLogger.logTrace(507880142,m.k.Error,`ensureTaskReferencePreviewThumbnail - task not in store [TaskId=${e.id}]`)}async convertSuggestionToAttachment(e,t){const s=this.entityStoreSet.taskStore.getTaskDetails(e),a=await this.logicModuleProviders.notificationModule();if(null==s)return;let r,i=t.webUrl||t.url;try{i=encodeURI(decodeURIComponent(i))}catch{return this.loggers.traceLogger.logTrace(507880140,m.k.Error,`Error encoding suggestion url for attachment [TaskId=${e}]`),void a.showErrorInternal(f.fc.ConvertSuggestionToAttachmentError,void 0,void 0,e)}const o=t.fileName.length>_.o.AliasMaxLength?t.fileName.substring(0,_.o.AliasMaxLength):t.fileName,l=S.Y.GetFileType(i);r=_.o.builder.withPropertyBag({url:i,alias:o,taskAttachmentType:x.builder.ofDriveItemType(l).build()}).build();if(we()(s.references??{}).indexOf(r.url)>-1)return void this.loggers.traceLogger.logTrace(507880139,m.k.Warning,`Suggestion already exists as attachment [TaskId=${e}][SuggestionId=${t.uniqueId}]`);let c;const d=s.getReferenceWithLowestPriority();let u;u=null!=d?Oe.O.generateOrderHintBetween(null,d.previewPriority):Oe.O.generateOrderHintBetween(null,null),r=r.setProperty("previewPriority",u),c=s.addAttachment(r),c.previewType===se.X.Automatic&&(c=c.setProperty("previewType",se.X.Reference)),this.loggers.usageLogger.logData(this.name,y.M.FileSuggestionToAttachment),this.updateTaskDetailsInternal(s,c).then(()=>{const e=new N.e(t.fileName);this.dispatcher.dispatchAction(new n.Z(e))}).catch(()=>{}),this.ensureTaskReferencePreviewThumbnail(c,r)}logMoveTask(e,t,s){const a=this.entityStoreSet.planStore.getPlan(e.planId),r=this.entityStoreSet.planStore.getPlanDetails(e.planId),i=null!=a&&null!=r?q.T.getFirstDisplayableContextString(a,r):"",n=null!=t.planDetails?q.T.getFirstDisplayableContextString(t.plan,t.planDetails):"";this.loggers.usageLogger.logData(this.name,"MoveTask",{originalTaskId:e.id,sourcePlanId:e.planId,targetPlanId:s.plan.id,sourceBucketId:e.bucketId??"",targetBucketId:s.bucketId??"",sourcePlanDisplayAs:i,targetPlanDisplayAs:n})}async fetchApprovalDetailsForTaskAsync(e){const t=await this.logicModuleProviders.taskModule();await t.fetchTaskApprovalDetailsAsync(e)}async createApprovalAsync(e,t){(await this.logicModuleProviders.taskModule()).createTaskApprovalAsync(e,t).catch(()=>{})}async cancelApprovalAsync(e){return(await this.logicModuleProviders.taskModule()).cancelApprovalAsync(e).catch(()=>{})}async updateApprovalStatusAsync(e,t,s){return(await this.logicModuleProviders.taskModule()).updateTaskApprovalAsync(e,t,s).catch(()=>{})}updateTaskDetailsInternal(e,t){const s=this.entityStoreSet.taskStore.getTask(e.id);if(null==s)throw new xe.m("originalTask","taskStore");const a=W.F.builder.withPropertyBag({task:s,taskDetails:e}).build(),r=W.F.builder.withPropertyBag({task:s,taskDetails:t}).build();return this.updateTaskAsync(a,r)}fetchPlanAndContainerBasedDependenciesForTask(e,t){this.fetchTaskContainer(e.id).then(async e=>{if(e.containerType===B.K.Group){const s=e,a=Ie()(t.references);if(s.unifiedGroupDetails&&a.length>0){(await this.logicModuleProviders.driveItemModule()).fetchTaskReferenceThumbnails(t,s.unifiedGroupDetails,a)}}}).catch(e=>{this.loggers.traceLogger.logTrace(507880138,m.k.Warning,`fetchPlanAndContainerBasedDependenciesForTask - fetchTaskContainer Failed ${(0,$e.s8)(e)}`)})}async fetchTaskContainer(e){const t=this.entityStoreSet.taskStore.getTask(e);if(null==t){const e="fetchTaskContainer called for an uncached task";return this.loggers.traceLogger.logTrace(507880137,m.k.Warning,e),Promise.reject(Ge.g.generateAjaxClientError(null,e))}return(await this.logicModuleProviders.planModule()).fetchPlanAsync(t.planId).then(async e=>(await this.logicModuleProviders.containerModule()).fetchContainer(e.plan.container,!0).catch(e=>(this.loggers.traceLogger.logTrace(507880136,m.k.Warning,`fetchTaskContainer - fetchContainer Failed ${(0,$e.s8)(e)}`),Promise.reject(e)))).catch(e=>(this.loggers.traceLogger.logTrace(507880135,m.k.Warning,`fetchTaskContainer - fetchPlanAsync Failed ${(0,$e.s8)(e)}`),Promise.reject(e)))}async shareDriveItem(e,t){try{const s=await this.logicModuleProviders.driveItemModule();await s.shareDriveItemAsync(e,t)}catch(s){const t=s;return(await this.logicModuleProviders.notificationModule()).handleRequestFailures(t,[k.t3.NotImplemented],[k.t3.Forbidden,k.t3.NotFound],f.fc.ShareDriveItemError,e),Promise.reject(t)}}async addNewMembersToContainer(e,t){const s=await this.logicModuleProviders.containerModule(),a=await this.logicModuleProviders.notificationModule();return s.addUsersToContainerAsync(t,e).then(()=>{},t=>{if(!(t.error instanceof $.U)){const s=t.response?.status,r=t.response?.statusText,i=t.error?.name;i===v.Zg?a.showInfoInternal(f.fc.PlanConvertingInfo):s===k.t3.NotImplemented?this.loggers.traceLogger.logTrace(507880134,m.k.Error,"addUsersToGroup - Not Implemented"):a.showErrorInternal(f.fc.AddUsersToGroupError,s,r,e.length.toString(),t.response)}return Promise.reject(t)})}async generateTaskActivityFeed(e,t){if(null!=t.task){const s=t.task.planId;if(null==s)return;const a=this.entityStoreSet.planStore.getPlanDetails(s);if(null==a){(await this.logicModuleProviders.planModule()).fetchPlanAsync(s).then(s=>{if(null==s.planDetails)return void this.dispatcher.dispatchAction(new r.j(null,"","planDetails wasn't returned by fetchPlanAsync"));const a=new Date,i=Ue.wS.generateEntityLink(t.task,f._n.Comment,f.rl.GroupMailbox,a),n=Ue.wS.generateEntityLink(s.plan,f._n.Comment,f.rl.GroupMailbox,a),o=this.taskActivityFeedProvider.getTaskActivityFeed(e,t,s.planDetails.notifyWhen,s.plan,i,n);null!=o&&this.postActivityFeed(t.task,o)},()=>{})}else{const r=this.entityStoreSet.planStore.getPlan(s);if(null==r)this.loggers.traceLogger.logTrace(507880133,m.k.Error,`generateTaskActivityFeed - plan not found [PlanId=${s}]`);else{const s=new Date,i=Ue.wS.generateEntityLink(t.task,f._n.Comment,f.rl.GroupMailbox,s),n=r?Ue.wS.generateEntityLink(r,f._n.Comment,f.rl.GroupMailbox,s):"",o=this.taskActivityFeedProvider.getTaskActivityFeed(e,t,a.notifyWhen,r,i,n);null!=o&&this.postActivityFeed(t.task,o)}}}}async postActivityFeed(e,t){if(null==e.planId)return;const s=this.entityStoreSet.planStore.getContainerIdForPlan(e.planId);if(null==s)return;const a=e.conversationThreadId,r=await this.logicModuleProviders.unifiedGroupModule();if(null!=a)r.postReplyInGroupConversationThread(s,a,t,!0).catch(e=>{const t=e.response?.status;t===k.t3.NotFound&&this.dispatcher.dispatchAction(new u.x(s,a))});else{const a=Le.o.generate(),i=Ae.i.getTaskCommentEmailSubject(e.title);r.createGroupConversationThread(s,a,t,e,i,!0).catch(()=>{})}}async ensureBucket(e,t){if(e===T.iR)return Promise.resolve(null);const s=await this.logicModuleProviders.bucketModule();if(null==e){const e=X.f.builder.withPropertyBag({id:"",title:Me.p.Strings.SharedComponents_DefaultBucketName,planId:t}).withLocallyUniqueId().build();return s.createBucketAsync(e)}{const a=await this.logicModuleProviders.notificationModule();return new Promise((r,i)=>{s.fetchBucketsForPlanAsync(t,!0).then(a=>{let n=null;if(a&&a.length>0){for(const t of a)if(t.id===e){n=t;break}n?r(n):(a.sort(Re.k),r(a[0]))}else{const e=X.f.builder.withPropertyBag({id:"",title:Me.p.Strings.SharedComponents_DefaultBucketName,planId:t}).withLocallyUniqueId().build();s.createBucketAsync(e).then(e=>{r(e)},e=>{i(e)})}},e=>{const s=e;a.handleRequestFailures(s,[],[k.t3.Forbidden,k.t3.NotFound],f.fc.GetBucketsForPlanError,t),i(e)})})}}async copyTaskAsync(e,t){try{const e=await this.logicModuleProviders.planModule();await e.fetchPlanAsync(t.plan.id,!0)}catch(y){const e=y;return(await this.logicModuleProviders.notificationModule()).handleRequestFailures(e,[],[k.t3.Forbidden,k.t3.NotFound],f.fc.GetPlanError,t.plan.id),Promise.reject(e)}const s=await this.ensureBucket(t.bucketId,t.plan.id);t={...t,bucketId:s?s.id:null};const a=await this.logicModuleProviders.taskModule(),r=await a.fetchTaskAsync(e);await a.fetchPlanTasksAsync(t.plan.id);const i=Le.o.generate();let n,o,l=se.X.Automatic;switch(r.task.previewType){case se.X.NoPreview:l=se.X.NoPreview;break;case se.X.Reference:l=t.copyReferences?se.X.Reference:se.X.Automatic;break;case se.X.CheckList:l=t.copyChecklist?se.X.CheckList:se.X.Automatic;break;case se.X.Description:l=t.copyDescription?se.X.Description:se.X.Automatic}if(t.copyAssignments&&!pe()(r.task.assignments)){const e={};ge()(r.task.assignments,(t,s)=>{e[s]=new Y.I(t.assignedBy,t.assignedDate.toDate())}),n=e}t.copyRecurrence&&null!=r.task.recurrence?.schedule&&(o=ae.G.builder.withRecurrenceSchedule(re.s.builder.withRecurrencePattern(le()(r.task.recurrence.schedule.pattern)).build().setRecurrenceRangeStartDate(r.task.dueDate)).build());let c=Z.Y.builder.withPropertyBag({id:i,title:t.title,planId:t.plan.id,percentComplete:t.copyProgress?r.task.percentComplete:(0,He.BK)(O.$.NotStarted),bucketId:t.bucketId,dueDate:t.copyDates?r.task.dueDate??void 0:void 0,startDate:t.copyDates?r.task.startDate??void 0:void 0,assignments:n,appliedCategories:t.copyLabels?r.task.appliedCategories:void 0,previewType:l,priority:r.task.priority,numberOfActiveChecklistItems:t.copyChecklist?r.task.numberOfActiveChecklistItems:void 0,numberOfChecklistItems:t.copyChecklist?r.task.numberOfChecklistItems:void 0,numberOfReferences:t.copyReferences?r.task.numberOfReferences:void 0,recurrence:o}).build();if(!r.taskDetails)throw new Be.n("ensuredTaskEntitySet.taskDetails");const d=r.taskDetails.getCopy(),u=K.U.builder.withPropertyBag({id:i,previewType:l,checklist:t.copyChecklist?d.checklist:void 0,description:t.copyDescription?d.description??void 0:void 0,notes:t.copyDescription&&d.notes?{content:d.notes.content,contentType:d.notes.contentType}??void 0:void 0,references:t.copyReferences?d.references:void 0}).build();let g=null,h=null,p=null;switch(this.entityStoreSet.viewStore.getCurrentTaskGroupingState(ee.t.Plan)){case T.Yc.Progress:g=this.calculateProgressFormattingForCopyOrMove(r.task,r.taskFormatData,c,t);break;case T.Yc.Assignee:h=this.calculateAssignedToFormattingForCopyOrMove(r.task,r.taskFormatData,c,t);break;case T.Yc.Bucket:p=this.calculateBucketFormattingForCopyOrMove(r.task,r.taskFormatData,c);break;case T.Yc.Plan:if(!this.entityStoreSet.appContextStore.getFlights().EnableFixedSortForAtmViews){const e=this.calculateAssigneePriorityForCopyOrMove(r.task,c);c=c.setProperty("assigneePriority",e)}}const m=V._.builder.withPropertyBag({assignedBoardFormat:h||void 0,bucketBoardFormat:p||void 0,progressBoardFormat:g||void 0}).build();return this.createTaskAsync(W.F.builder.withTask(c).withDetails(u).withFormatData(m).build(),void 0,!0)}async createTaskAsync(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=await this.logicModuleProviders.taskModule();if(e.id&&null==e.taskDetails){const t=K.U.builder.withId(e.id).build();e=W.F.builder.forClone(e).withDetails(t).build()}const i=W.F.builder.withDetails(e.taskDetails).withTask(e.task).withFormatData(e.taskFormatData).build(),o=await this.logicModuleProviders.notificationModule();return r.createTaskAsync(i,t,(e,t)=>{const n=e.response?.status,l=e.response?.statusText,c=()=>{const t=e.error?.name;t===v.Zg?o.showInfoInternal(f.fc.PlanConvertingInfo):o.showErrorInternal(f.fc.CreateTaskError,n,l,void 0,e.response,[i.task.title])};if(n!==k.t3.BadRequest||a)t(),c();else try{r.fixTaskOrderHintPrecision(null,i,c,this.reorderTaskGroups.bind(this),(e,t,a)=>this.fixCreateTask(e,t,a,s),t)}catch(d){this.loggers.traceLogger.logTrace(507639449,m.k.Error,`createTaskAsync - fixTaskOrderHintPrecision failed ${(0,$e.LB)(d)}`),t(),c()}}).then(e=>{if(s){const t=new U.g(e.task.id,e.task.title,Ue.wS.generateEntityLink(e.task,f._n.TaskLink,f.rl.Link,new Date));this.dispatcher.dispatchAction(new n.Z(t))}else o.enqueueHiddenToastNotification("SharedComponents_CreateTaskToastTitle",[],i.task.title);this.loggers.usageLogger.logData(this.name,y.M.CreateTask,{isCopyOperation:String(s)});const t=we()(e.task.assignments);if(!pe()(t)){const s={planId:e.task.planId,assigneeIds:t.join(",")};this.loggers.usageLogger.logData(this.name,y.M.AssignTaskSuccessful,s)}const a=this.entityStoreSet.appContextStore.getCurrentUserId(),r=this.entityStoreSet.userStore.getUserDetailsById(a);return r?.isUserAccessWithin24Hours()&&this.loggers.usageLogger.logData(this.name,y.M.CreateTaskIn24h,{isCopyOperation:String(s)}),this.generateTaskActivityFeed(null,e),e})}async deleteTaskAsync(e,t){const s=this.entityStoreSet.taskStore.getTask(e);if(null==s)throw this.loggers.usageLogger.logData(this.name,"deleteTask::task not in store",{taskId:e}),new xe.m("task","taskStore");try{this.loggers.usageLogger.logData(this.name,y.M.DeleteTask);const a=await this.logicModuleProviders.taskModule(),r=await a.deleteTaskAsync(e,t),i=new c(r,()=>this.undeleteTask(r));this.dispatcher.dispatchAction(i);const o=new H.W(s.title,()=>{this.dispatcher.dispatchAction(new d(i.actionId))});this.dispatcher.dispatchAction(new n.Z(o)),s.recurrence?.isActive()&&null!=r.task.recurrence?.nextInSeriesTaskId&&this.fetchTaskEntityGroup(r.task.recurrence.nextInSeriesTaskId)}catch(a){const t=a,s=await this.logicModuleProviders.notificationModule();if(!(t.error instanceof $.U)){const a=t.error?.name;if(a===v.Zg)s.showInfoInternal(f.fc.PlanConvertingInfo);else{const a=t.response?.status,r=t.response?.statusText;s.showErrorInternal(f.fc.DeleteTaskError,a,r,e,t.response)}}}}async deleteTaskSeriesAsync(e){const t=this.entityStoreSet.taskStore.getTask(e);if(null==t)throw new xe.m("task","taskStore");const s=W.F.builder.withTask(t).build(),a=t.setRecurrenceSchedule(null);let r=!1;try{const e=await this.logicModuleProviders.taskModule(),i=await e.updateTaskAsync(s,W.F.builder.withTask(a).build());r=!0,this.loggers.usageLogger.logData(this.name,y.M.DeleteTask),await e.deleteTaskAsync(i.task.id,i.task.itemVersion);const o=new R.N(t.title);this.dispatcher.dispatchAction(new n.Z(o))}catch(i){const t=i;if(!(t.error instanceof $.U)){const s=await this.logicModuleProviders.notificationModule(),a=t.error?.name;if(a===v.Zg)s.showInfoInternal(f.fc.PlanConvertingInfo);else{const a=t.response?.status,i=t.response?.statusText,n=r?f.fc.DeleteRecurringTaskSeriesDeleteError:f.fc.DeleteRecurringTaskSeriesUpdateError;s.showErrorInternal(n,a,i,e,t.response)}}}}async updateTaskAsync(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0;const i=await this.logicModuleProviders.taskModule();if(fe()(e,t,Ee.lz.isEqualMomentCustomizer))return Promise.resolve(t);t.task.isComplete()&&!e.task.isComplete()&&p.B.clientType!==Xe.s.SharepointApp&&p.B.clientType!==Xe.s.Webpart&&this.taskCompletionSoundAudio.play();const o=e.task.getDiff(t.task),l=null!=e.taskDetails&&null!=t.taskDetails?e.taskDetails.getDiff(t.taskDetails):{},c=null!=e.taskFormatData?.assignmentBoardFormat&&null!=t.taskFormatData?.assignmentBoardFormat?e.taskFormatData.assignmentBoardFormat.getDiff(t.taskFormatData.assignmentBoardFormat):{},d=null!=e.taskFormatData?.bucketBoardFormat&&null!=t.taskFormatData?.bucketBoardFormat?e.taskFormatData.bucketBoardFormat.getDiff(t.taskFormatData.bucketBoardFormat):{},u=null!=e.taskFormatData?.progressBoardFormat&&null!=t.taskFormatData?.progressBoardFormat?e.taskFormatData.progressBoardFormat.getDiff(t.taskFormatData.progressBoardFormat):{};this.logUpdateTaskUsage(o,e.task,t.task),this.logUpdateTaskDetailsUsage(e.task,l,e.taskDetails,t.taskDetails),this.logUpdateTaskFormatsUsage(e.id,c,d,u);const g=await this.logicModuleProviders.notificationModule();return i.updateTaskAsync(e,t,r,(r,n)=>{const o=r.response?.status,l=r.response?.statusText,c=r.error?.name,d=()=>{c===v.Zg?g.showInfoInternal(f.fc.PlanConvertingInfo):g.showErrorInternal(f.fc.UpdateTaskError,o,l,e.id,r.response)},u=o===k.t3.PreconditionFailed&&"The ETag value is too old, the item must be read again."===r.error?.message;if(o===k.t3.Conflict||u)n(),i.fetchTaskAsync(e.id,!0).catch(e=>{this.loggers.traceLogger.logTrace(507880132,m.k.Warning,`UpdateTaskAsync - 409/412 Recovery - fetchTaskAsync Fail ${(0,$e.s8)(e)}`)});else if(o!==k.t3.BadRequest||s)if(o===k.t3.NotFound){const t=e.task?e.task.title:"";this.dispatcher.dispatchAction(new a.i(f.fc.UpdateDeletedTaskInfo,o,l,e.id,[t]))}else n(),d();else try{i.fixTaskOrderHintPrecision(e,t,d,this.reorderTaskGroups.bind(this),this.fixUpdateTask.bind(this),n)}catch(h){this.loggers.traceLogger.logTrace(507639448,m.k.Error,`updateTaskAsync - fixTaskOrderHintPrecision failed ${(0,$e.LB)(h)}`),n(),d()}}).then(s=>{if(null!=e.task&&null!=s.task&&this.generateTaskActivityFeed(e,s),null!=e.task&&null!=t.task&&e.task.planId!==t.task.planId){const e=new G.c(t.task.id,t.task.title,Ue.wS.generateEntityLink(t.task,f._n.TaskLink,f.rl.Link,new Date));this.dispatcher.dispatchAction(new n.Z(e))}else g.announceTaskUpdates(o,e.task),e.taskDetails&&g.announceTaskDetailsUpdates(l,e.taskDetails),g.announceTaskReorder(o,c,d,u,e,s.task.title);return e.task.recurrence?.isActive()&&null!=s.task.recurrence?.nextInSeriesTaskId&&this.fetchTaskEntityGroup(s.task.recurrence.nextInSeriesTaskId),s},t=>(this.loggers.traceLogger.logTrace(507880131,m.k.Info,`Task update failed - [TaskCreationSourceType=${e.task.taskCreationSourceType}]`),Promise.reject(t)))}logUpdateTaskUsage(e,t,s){if(!pe()(e)){const e=this.entityStoreSet.appContextStore.getCurrentUserId(),a=this.entityStoreSet.userStore.getUserDetailsById(e),r=!!a&&a.isUserAccessWithin24Hours();if(this.loggers.usageLogger.logData(this.name,y.M.TaskUpdated,{taskCreationSourceType:t.taskCreationSourceType}),r&&this.loggers.usageLogger.logData(this.name,y.M.TaskUpdatedIn24h,{taskCreationSourceType:t.taskCreationSourceType}),!me()(t.assignments,s.assignments)){const e=de()(we()(s.assignments),e=>null==t.assignments[e]),a=de()(we()(t.assignments),e=>null==s.assignments[e]),i=e.length,n=a.length;if(i>0||n>0){const e=null!=this.entityStoreSet.planStore.getPlanDetails(s.planId)?.background.overlayImage;this.loggers.usageLogger.logData(this.name,y.M.TaskAssigned,{newAssigmentsCount:String(i),removedAssignmentsCount:String(n),planHasBackground:String(e),taskCreationSourceType:t.taskCreationSourceType}),r&&this.loggers.usageLogger.logData(this.name,y.M.TaskAssignedIn24h,{newAssigmentsCount:String(i),removeAssignmentsCount:String(n),taskCreationSourceType:t.taskCreationSourceType})}}if(t.percentComplete!==s.percentComplete&&(this.loggers.usageLogger.logData(this.name,y.M.TaskProgressChanged,{taskCreationSourceType:t.taskCreationSourceType}),(0,He.Fk)(s.percentComplete)===O.$.Complete&&this.loggers.usageLogger.logData(this.name,y.M.TaskCompleted,{taskCreationSourceType:t.taskCreationSourceType}),(0,He.Fk)(t.percentComplete)===O.$.Complete&&this.loggers.usageLogger.logData(this.name,y.M.TaskReactivated,{taskCreationSourceType:t.taskCreationSourceType})),me()(t.appliedCategories,s.appliedCategories)||(t.appliedCategories.length>s.appliedCategories.length?this.loggers.usageLogger.logData(this.name,y.M.RemoveLabelFromTask,{taskCreationSourceType:t.taskCreationSourceType}):t.appliedCategories.length<s.appliedCategories.length&&this.loggers.usageLogger.logData(this.name,y.M.AddLabelToTask,{taskCreationSourceType:t.taskCreationSourceType})),t.bucketId!==s.bucketId&&this.loggers.usageLogger.logData(this.name,"TaskBucketUpdated",{sourceBucketId:t.bucketId??"null",targetBucketId:s.bucketId??"null",taskCreationSourceType:t.taskCreationSourceType}),t.priority!==s.priority&&this.loggers.usageLogger.logData(this.name,"TaskPriorityUpdated",{taskCreationSourceType:t.taskCreationSourceType}),!me()(t.startDate,s.startDate)){let e="TaskStartDate";t.startDate?s.startDate?e+="Updated":e+="Removed":e+="Set",this.loggers.usageLogger.logData(this.name,e,{taskCreationSourceType:t.taskCreationSourceType})}if(!me()(t.dueDate,s.dueDate)){let e="TaskDueDate";t.dueDate?s.dueDate?e+="Updated":e+="Removed":e+="Set",this.loggers.usageLogger.logData(this.name,e,{taskCreationSourceType:t.taskCreationSourceType})}t.title!==s.title&&this.loggers.usageLogger.logData(this.name,"TaskTitleUpdated",{taskCreationSourceType:t.taskCreationSourceType}),fe()(t.recurrence,s.recurrence,Ee.lz.isEqualMomentCustomizer)||this.loggers.usageLogger.logData(this.name,"TaskRecurrenceChanged",{taskCreationSourceType:t.taskCreationSourceType})}}logUpdateTaskDetailsUsage(e,t,s,a){if(!pe()(t)&&null!=s&&null!=a){if(this.loggers.usageLogger.logData(this.name,y.M.TaskDetailsUpdated,{taskCreationSourceType:e.taskCreationSourceType??""}),s.description!==a.description){let e;e=pe()(s.description)?"TaskNotesSet":pe()(a.description)?"TaskNotesRemoved":"TaskNotesUpdated",this.loggers.usageLogger.logData(this.name,e)}if(!me()(s.notes,a.notes)){let e;e=pe()(s.notes?.content)?"TaskRichNotesSet":pe()(a.notes?.content)?"TaskRichNotesRemoved":"TaskRichNotesUpdated",this.loggers.usageLogger.logData(this.name,e)}if(!me()(s.checklist,a.checklist)){const e=de()(we()(a.checklist),e=>null==s.checklist[e]),t=de()(we()(s.checklist),e=>null==a.checklist[e]),r=e.length,i=t.length;(r>0||i>0)&&this.loggers.usageLogger.logData(this.name,"TaskChecklist",{newChecklistCount:String(r),removedChecklistCount:String(i)})}if(!me()(s.references,a.references)){const e=de()(we()(a.references),e=>null==s.references[e]),t=de()(we()(s.references),e=>null==a.references[e]),r=e.length,i=t.length;(r>0||i>0)&&this.loggers.usageLogger.logData(this.name,"TaskAttachments",{newAttachmentsCount:String(r),removedAttachmentsCount:String(i)})}if(t.previewType){let e;e=t.previewType===se.X.NoPreview?"TaskPreviewTypeRemoved":"TaskPreviewTypeSet",this.loggers.usageLogger.logData(this.name,e,{previewType:String(a.previewType)})}}}logUpdateTaskFormatsUsage(e,t,s,a){let r={};pe()(t)||(r={...r,assigneeOrderHintsFormat:String(!pe()(t.orderHintsByAssignee)),unassignedOrderHintFormat:String(!pe()(t.unassignedOrderHint))}),pe()(s)||(r={...r,bucketFormat:String(!0)}),pe()(a)||(r={...r,progressFormat:String(!0)}),pe()(r)||this.loggers.usageLogger.logData(this.name,"TaskFormatsUpdated",r)}reorderTaskGroups(e,t){const s=[];return b()(e,e=>{t?pe()(e.aboveTasks)||null==e.aboveTasks?s.push(Promise.resolve(e)):s.push(this.reorderTaskCard(e.aboveTasks,e)):pe()(e.belowTasks)||null==e.belowTasks?s.push(Promise.resolve(e)):s.push(this.reorderTaskCard(e.belowTasks,e))}),pe()(s)?Promise.resolve([]):Promise.allSettled(s).then(e=>{const t=[];let s=!1,a=null;return b()(e,e=>{"rejected"===e.status?(s=!0,a=e.reason):null==e.value?s=!0:t.push(e.value)}),s?Promise.reject(a):t})}fixCreateTask(e,t,s){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=t.taskFormatData;null!=r&&b()(s,e=>{r=e.setOrderHint(r,e.nextOrderHint,e.pivotValue)});const i=W.F.builder.withTask(t.task).withDetails(t.taskDetails).withFormatData(r).build();return new Promise((e,t)=>{this.createTaskAsync(i,void 0,a,!0).then(t=>{const a=[];b()(s,e=>{e.nextOrderHint=Oe.O.generateOrderHintBetween(null!=t.taskFormatData?e.getOrderHint(t.taskFormatData,e.pivotValue):null,null),a.push(e)}),e(a)},e=>{t(e)})})}fixUpdateTask(e,t,s){if(null==e)return Promise.reject("originalTaskInfo is null!");let a=t.taskFormatData;null!=a&&b()(s,e=>{a=e.setOrderHint(a,e.nextOrderHint,e.pivotValue)});const r=W.F.builder.withTask(t.task).withDetails(t.taskDetails).withFormatData(a).build();return new Promise((t,a)=>{this.updateTaskAsync(e,r,!0).then(e=>{const a=[];b()(s,t=>{t.nextOrderHint=Oe.O.generateOrderHintBetween(null!=e.taskFormatData?t.getOrderHint(e.taskFormatData,t.pivotValue):null,null),a.push(t)}),t(a)},e=>{a(e)})})}async reorderTaskCard(e,t){const s=await this.logicModuleProviders.taskModule();return new Promise((a,r)=>{const i=e.shift();if(null==i){const e="reorderTaskCard null task",t=new Response("Bad request",{status:k.t3.BadRequest,statusText:"Bad Request"});r(Ge.g.generateAjaxClientError(t,e))}else if(M()(this.inProgressTaskReorderIds,i.id)>-1)e.unshift(i),setTimeout(()=>{this.reorderTaskCard(e,t).then(e=>{a(e)},e=>{r(e)})},4e3);else{this.inProgressTaskReorderIds.push(i.id);const n=W.F.builder.withTask(i).withFormatData(this.entityStoreSet.taskStore.getTaskboardTaskFormatting(i.id)||void 0).build(),o=n.taskFormatData?t.setOrderHint(n.taskFormatData,t.nextOrderHint,t.pivotValue):n.taskFormatData;s.updateTaskAsync(n,W.F.builder.withTask(i).withFormatData(o).build()).then(s=>{Pe()(this.inProgressTaskReorderIds,i.id),t.nextOrderHint=Oe.O.generateOrderHintBetween(s.taskFormatData?t.getOrderHint(s.taskFormatData,t.pivotValue):null,null),e.length>0?this.reorderTaskCard(e,t).then(e=>{a(e)},e=>{r(e)}):a(t)},e=>{if(Pe()(this.inProgressTaskReorderIds,i.id),!(e.error instanceof $.U)){const t=e.response?.status;t===k.t3.Conflict&&this.fetchTaskEntityGroup(n.id,!0,!0)}r(e)})}})}calculateProgressFormattingForCopyOrMove(e,t,s,a){const r=this.entityStoreSet.taskStore.getTasksForPlan(s.planId)||[],i=ve()(this.entityStoreSet.taskStore.getTaskboardTaskFormattingForPlan(s.planId,te.s.Progress),"id"),n=(0,Ne.py)(r,i,!0);let o,l=null,c=null,d=null;if(a&&!a.copyProgress){const e=n.filter(e=>e.pivotValue===O.$.NotStarted)[0],t=e?.dataEntities?.[0]??null;if(null!=t){const e=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(t.id);l=e?.progressBoardFormat??null}o=Oe.O.generateOrderHintBetween(null,l?l.orderHint:null)}else{const a=n.filter(t=>t.pivotValue===(0,He.Fk)(e.percentComplete))[0];if(e.planId===s.planId){if(a?.dataEntities){const t=a.dataEntities.indexOf(e);if(t<a.dataEntities.length-1){const e=a.dataEntities[t+1],s=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);l=s?.progressBoardFormat??null}}c=t?.progressBoardFormat??null}else if(a?.dataEntities&&a.dataEntities.length>0){const e=a.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);l=t?.progressBoardFormat??null}o=Oe.O.generateOrderHintBetween(c?c.orderHint:null,l?l.orderHint:null)}return d=z.j.builder.withPropertyBag({id:s.id,orderHint:o}).build(),d}calculateAssignedToFormattingForCopyOrMove(e,t,s,a){const r=this.entityStoreSet.planStore.getPlan(s.planId),i=this.entityStoreSet.taskStore.getTasksForPlan(s.planId)||[],n=ve()(this.entityStoreSet.taskStore.getTaskboardTaskFormattingForPlan(s.planId,te.s.AssignedTo),"id");let o;null==r?(this.loggers.traceLogger.logTrace(507880130,m.k.Error,`calculateAssignedToFormattingForCopyOrMove - no plan for task [TaskId=${s.planId}]`),o=""):o=r.container.externalId;const l=ve()(this.entityStoreSet.userStore.getContainerUsers(o),"id"),c=(0,Ne.Fy)(i,n,l,this.entityStoreSet.appContextStore.getCurrentUserId());let d=null,u=null,g=null;if(a&&!a.copyAssignments){const e=c.filter(e=>null===e.pivotValue)[0],t=e?.dataEntities?.[0]??null;if(null!=t){const e=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(t.id);d=e?.assignmentBoardFormat??null}const a=Oe.O.generateOrderHintBetween(null,d?d.unassignedOrderHint:null);g=J.x.builder.withPropertyBag({id:s.id,unassignedOrderHint:a}).build()}else if(pe()(e.getAssigneeIds())){const a=c.filter(e=>null===e.pivotValue)[0];if(e.planId===s.planId){const s=a?.dataEntities?a.dataEntities.indexOf(e):-1;if(a?.dataEntities&&s<a.dataEntities.length-1){const e=a.dataEntities[s+1],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=t?.assignmentBoardFormat??null}u=t?.assignmentBoardFormat??null}else if(a?.dataEntities&&a.dataEntities.length>0){const e=a.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=t?.assignmentBoardFormat??null}const r=Oe.O.generateOrderHintBetween(u?u.unassignedOrderHint:null,d?d.unassignedOrderHint:null);g=J.x.builder.withPropertyBag({id:s.id,unassignedOrderHint:r}).build()}else{const a={};b()(e.getAssigneeIds(),r=>{const i=c.filter(e=>e.pivotValue===r)[0];if(e.planId===s.planId){const s=i?.dataEntities?i.dataEntities.indexOf(e):-1;if(i?.dataEntities&&s<i.dataEntities.length-1){const e=i.dataEntities[s+1],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=t?.assignmentBoardFormat??null}u=t?.assignmentBoardFormat??null}else if(i?.dataEntities&&i.dataEntities.length>0){const e=i.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=t?.assignmentBoardFormat??null}a[r]=Oe.O.generateOrderHintBetween(u?u.orderHintsByAssignee[r]:null,d?d.orderHintsByAssignee[r]:null)}),g=J.x.builder.withPropertyBag({id:s.id,orderHintsByAssignee:a}).build()}return g}calculateBucketFormattingForCopyOrMove(e,t,s){const a=this.entityStoreSet.taskStore.getTasksForPlan(s.planId)||[],r=ve()(this.entityStoreSet.taskStore.getTaskboardTaskFormattingForPlan(s.planId,te.s.Bucket),"id");let i=null,n=null,o=null;const l=(0,Ne.M1)(a,r,this.entityStoreSet.bucketStore.getBucketsForPlan(s.planId)??[]).filter(e=>e.pivotValue===s.bucketId)[0];if(e.bucketId===s.bucketId){const s=l?.dataEntities?l.dataEntities.indexOf(e):-1;if(l?.dataEntities&&s<l.dataEntities.length-1){const e=l.dataEntities[s+1],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);i=t?.bucketBoardFormat??null}n=t?.bucketBoardFormat??null}else if(l?.dataEntities&&l.dataEntities.length>0){const e=l.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);i=t?.bucketBoardFormat??null}const c=Oe.O.generateOrderHintBetween(n?n.orderHint:null,i?i.orderHint:null);return o=Q.g.builder.withPropertyBag({id:s.id,orderHint:c}).build(),o}calculateAssigneePriorityForCopyOrMove(e,t){const s=this.entityStoreSet.taskStore.getTasksForUser(p.B.currentUserId),a=s?s.filter(t=>e.isComplete()?t.isComplete():!t.isComplete()):[],r=a.map(e=>e.planId),i=(0,Ne.V2)(a,r,[],!1).filter(e=>e.pivotValue===t.planId)[0];let n=null,o=null;if(e.planId===t.planId){const t=i?.dataEntities?i.dataEntities.indexOf(e):-1;if(i?.dataEntities&&t<i.dataEntities.length-1){n=i.dataEntities[t+1].assigneePriority??null}o=e.assigneePriority??null}else if(i?.dataEntities&&i.dataEntities.length>0){n=i.dataEntities[0].assigneePriority??null}return Oe.O.generateOrderHintBetween(o,n)}constructor(e,t,s,a,r,i){super(e,t,s,p.B.clientSettings,r),this.taskActivityFeedProvider=a,this.inProgressTaskReorderIds=[],this.shareDeepLinkCallback=i,this.taskCompletionSoundAudio=new Audio(ne)}}},23918:(e,t,s)=>{s.d(t,{Y:()=>m});var a=s(91675),r=s(51171),i=s(57718),n=s(86178),o=s.n(n),l=s(14983),c=function(){function e(){this.id=i.cM(),this.name="",this.fileType=l.Er.Other,this.url="",this.modifiedDate=o()(),this.childCount=-1,this.itemPath="/drive/root:"}return e.prototype.build=function(){return new m(this)},e.prototype.withPropertyBag=function(e){return this.id=e.id||this.id,this.name=e.name||this.name,this.fileType=e.fileType||this.fileType,this.url=e.url||this.url,this.modifiedDate=e.modifiedDate||this.modifiedDate,this.childCount=void 0!==e.childCount?e.childCount:this.childCount,this.itemPath=e.itemPath||this.itemPath,this},e.prototype.withDefaultValues=function(){return this.withPropertyBag({id:"driveItemId",name:"Item1",fileType:l.Er.Other,url:"driveItemUrl",modifiedDate:o()(),itemPath:"/drive/root:",childCount:-1})},e.prototype.fromGraphDriveItemResource=function(e){return this.withPropertyBag({id:e.id,name:e.name,fileType:e.folder?l.Er.Other:e.package?m.GetType(e.package.type):m.GetFileType(e.name),url:e.webUrl,modifiedDate:o()(e.lastModifiedDateTime),childCount:e.folder?e.folder.childCount:-1,itemPath:e.parentReference.path})},e}(),d=s(98990),u=s.n(d),g=s(55491),h=s.n(g),p=s(54320),k=s.n(p),m=function(){function e(e){if(k()(e.id))throw new r.L("id");if(k()(e.name))throw new r.L("name");if(k()(e.url))throw new r.L("url");this.id=e.id,this.name=e.name,this.url=e.url,this.fileType=e.fileType,this.description=e.description,this.modifiedDate=e.modifiedDate,this.childCount=e.childCount,this.itemPath=e.itemPath}return Object.defineProperty(e,"builder",{get:function(){return new c},enumerable:!1,configurable:!0}),e.GetType=function(e){switch(e.toLowerCase()){case"excel":return l.Er.Excel;case"onenote":return l.Er.OneNote;case"pdf":return l.Er.Pdf;case"powerpoint":return l.Er.PowerPoint;case"project":return l.Er.Project;case"visio":return l.Er.Visio;case"word":return l.Er.Word;case"loop":return l.Er.Loop;default:return l.Er.Other}},e.GetFileType=function(t){var s=l.Er.Other,r=t.slice(t.lastIndexOf(".")+1);return h()(a.t,function(t,a){u()(t,function(e){return e.toLowerCase()===r.toLowerCase()})&&(s=e.GetType(a))}),s},e}()},27916:(e,t,s)=>{var a,r,i,n,o;s.d(t,{Zg:()=>l}),function(e){e[e.OK=0]="OK",e[e.ContainsDefaultReservedWords=1]="ContainsDefaultReservedWords",e[e.MissingPrefixSuffix=2]="MissingPrefixSuffix",e[e.ContainsCustomBlockedWords=3]="ContainsCustomBlockedWords",e[e.ContainsMSStandardBlockedWords=4]="ContainsMSStandardBlockedWords",e[e.MailNicknameNotOK=5]="MailNicknameNotOK",e[e.Unknown=6]="Unknown"}(a||(a={})),function(e){e.Forbidden="Forbidden",e.NotFound="NotFound",e.CreatePlanForGroupFailed="CreatePlanForGroupFailed",e.MaximumPlansOwnedByUserReached="MaximumPlansOwnedByUserReached",e.UnknownError="UnknownError"}(r||(r={})),function(e){e.Offline="Offline"}(i||(i={})),function(e){e.DynamicImportError="DynamicImportError"}(n||(n={})),function(e){e.MaximumProjectsOwnedByUser="MaximumProjectsOwnedByUser",e.MaximumProjectsSharedWithUser="MaximumProjectsSharedWithUser",e.MaximumTasksCreatedByUser="MaximumTasksCreatedByUser",e.MaximumTasksAssignedToUser="MaximumTasksAssignedToUser",e.MaximumTasksInProject="MaximumTasksInProject",e.MaximumActiveTasksInProject="MaximumActiveTasksInProject",e.MaximumBucketsInProject="MaximumBucketsInProject",e.MaximumUsersSharedWithProject="MaximumUsersSharedWithProject",e.MaximumReferencesOnTask=" MaximumReferencesOnTask",e.MaximumChecklistItemsOnTask="MaximumChecklistItemsOnTask",e.MaximumAssigneesInTasks="MaximumAssigneesInTasks",e.MaximumFavoritePlansForUser="MaximumFavoriteProjectsForUser",e.MaximumRecentPlansForUser="MaximumRecentProjectsForUser",e.MaximumContextsOnPlan="MaximumContextsOnPlan"}(o||(o={}));const l="ArchivedEntityCanNotBeUpdated"},36591:(e,t,s)=>{s.d(t,{C:()=>a});class a{constructor(e,t,s,a,r){this.dispatcher=e,this.logicModuleProviders=t,this.entityStoreSet=s,this.clientSettings=a,this.loggers=r}}},39156:(e,t,s)=>{s.d(t,{n:()=>a});class a extends Error{constructor(e){super(),Object.setPrototypeOf(this,a.prototype),this.message=`${e} should not be null`,this.name="NullReferenceError"}}},57718:(e,t,s)=>{function a(e){for(var t="";t.length<e;){var s=16*Math.random();t+=(s|=0).toString(16)}return t}s.d(t,{cM:()=>r});function r(){var e=[];e.push(a(8)),e.push(a(4));var t="4"+a(3);e.push(t);var s=a(4),r=parseInt(s[0],16);return r&=3,s=(r|=8).toString(16)+s.substr(1),e.push(s),e.push(a(12)),e.join("-")}},70776:(e,t,s)=>{s.d(t,{k:()=>r});var a=s(28730);function r(e,t){return a.l.compareByOrderHint(t,e,e=>e?e.orderHint:null)}},91675:(e,t,s)=>{s.d(t,{t:()=>a});var a={Word:["docx","docm","doc","dotx","dotm"],Excel:["xlsx","xlsm","xlsb","xltx","xltm","xls","xlam","xla","xlw","xml"],PowerPoint:["pptx","pptm","ppt","potx","potm","pot","thmx","pps","ppsx","ppsm","ppsam","ppa"],OneNote:["one"],Project:["mpp","mpt","mpd"],Visio:["vsdx","vsd","vsdm","vssx","vssm","vstx","vstm"],Pdf:["pdf"],Loop:["loop","fluid"]}}}]);
//# sourceMappingURL=taskac.d16ac60f.chunk.js.map