/*! For license information please see createNewModule.86f9750c.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[72883],{24106:(e,t,n)=>{n.d(t,{e:()=>a});var r=n(87804),o=n(39521);class a extends o.iq{constructor(e){super(e,{usageError:!0}),this.errorType=r.a.usageError,this.canRetry=!1}}},39480:(e,t,n)=>{n.r(t),n.d(t,{convertCreateNewSummaryTreeToTreeAndBlobs:()=>T,createNewContainerOnExistingFile:()=>O,createNewFluidFile:()=>U,renameEmptyFluidFile:()=>F});var r=n(85038),o=n(54813),a=n(93586),i=n(63520),s=n(27250),c=n(93220),l=n(57471),d=n(58358),p=n(11137),u=n(27015),m=n(70530),h=n(27612),f=n(62951),y=n(41818),w=n(86664),b=n(84693),g=n(34904),v=n(52076),k=n(14826);function T(e,t){const n=e.tree[".protocol"],r=(0,g.YG)(n).sequenceNumber,o=new Map,a=N(e,o);a.id=t;return{snapshotTree:a,blobContents:o,ops:[],sequenceNumber:r,latestSequenceNumber:r,snapshotFormatV:1}}function N(e,t){const n={blobs:{},trees:{},unreferenced:e.unreferenced,groupId:e.groupId},r=Object.keys(e.tree);for(const o of r){const r=e.tree[o];switch(r.type){case b.Z.Tree:n.trees[o]=N(r,t);break;case b.Z.Blob:{const e="string"===typeof r.content?(0,y.Xg)(r.content,"utf8"):r.content,a=(0,k.A)();n.blobs[o]=a,t.set(a,e);break}case b.Z.Handle:case b.Z.Attachment:throw new Error(`No ${r.type} should be present for detached summary!`);default:(0,w.$)(r,`Unknown tree type ${r.type}`)}}return n}function A(e){if(!(0,g.ub)(e))throw new Error("App and protocol summary required for create new path!!");const t=e.tree[".app"],n=e.tree[".protocol"],r=(0,g.YG)(n),o={type:b.Z.Blob,content:JSON.stringify(r)};n.tree.attributes=o;return{entries:I({type:b.Z.Tree,tree:{".protocol":n,".app":t}}).entries??[],message:"app",sequenceNumber:r.sequenceNumber,type:"container"}}function I(e){const t={type:"tree",entries:[]},n=Object.keys(e.tree);for(const o of n){(0,r.vA)(!o.includes("/"),2508);const n=e.tree[o];let a,i,s;switch(n.type){case b.Z.Tree:a=I(n),i=n.unreferenced,s=n.groupId;break;case b.Z.Blob:a={type:"blob",content:"string"===typeof n.content?n.content:(0,y.Km)(n.content,"base64"),encoding:"string"===typeof n.content?"utf-8":"base64"};break;case b.Z.Handle:throw new Error("No handle should be present for first summary!!");default:throw new Error(`Unknown tree type ${n.type}`)}const c={path:o,type:(0,v.hK)(n),value:a,unreferenced:i,groupId:s};t.entries?.push(c)}return t}async function $(e){const{containerSnapshot:t,getAuthHeader:n,logger:r,initialUrl:o,epochTracker:a,telemetryName:i,fetchType:c,validateResponseCallback:l}=e,p=(0,u.ir)(o);return(0,m.gO)(async e=>s.Bt.timedExecAsync(r,{eventName:i,details:{internalFarmType:p}},async s=>{const p=JSON.stringify(t);let u,h,y=!1;const w=(0,k.A)(),b=new URL(o);b.searchParams.set("ump","1");const g=b.href,v="POST",T=await n({...e,request:{url:g,method:v}},i),N=`--${w}\r\nAuthorization: ${T}\r\nX-HTTP-Method-Override: POST\r\nContent-Type: application/json\r\n_post: 1\r\n\r\n${p}\r\n\r\n--${w}--`;let A=p;if((new TextEncoder).encode(N).length<=m.K3&&T?.startsWith("Bearer"))u=g,h={"Content-Type":`multipart/form-data;boundary=${w}`},y=!0,A=N;else{u=o;const t=await n({...e,request:{url:u,method:v}},i);h={...(0,d.b)(t),"Content-Type":"application/json"},A=p}const I=await(0,f.M)(async()=>a.fetchAndParseAsJSON(u,{body:A,headers:h,method:v},c,y),i,r);return l?.(I.content),s.end({attempts:e.refresh?2:1,...I.propsToLog}),I.content}))}const C=e=>/["*/:<>?\\|]+/g.test(e);async function U(e,t,n,y,w,b,g,v,k,N,I){if(C(t.filename))throw new o.OI("Invalid filename for createNew",a.E.invalidFileNameError,{driverVersion:h.z});let U,F,L,O="";if(void 0===y){const r=await async function(e,t,n,r){const i=S(t.filePath),c=encodeURIComponent(`${t.filename}.tmp`),l=`${(0,u.lA)(new URL(t.siteUrl))}/drives/${t.driveId}/items/root:/${i}/${c}:/content?@name.conflictBehavior=rename&select=id,name,parentReference`;return(0,m.gO)(async i=>{const c=l,p="PUT",m=await e({...i,request:{url:c,method:p}},"CreateNewFile"),y=(0,u.ir)(t.siteUrl);return s.Bt.timedExecAsync(n,{eventName:"createNewEmptyFile",details:{internalFarmType:y}},async e=>{const t=(0,d.b)(m);t["Content-Type"]="application/json";const i=await(0,f.M)(async()=>r.fetchAndParseAsJSON(c,{body:void 0,headers:t,method:p},"createFile"),"createFile",n),s=i.content;if(!s?.id)throw new o.OI("ODSP CreateFile call returned no item ID (for empty file)",a.E.incorrectServerResponse,{driverVersion:h.z});return e.end({...i.propsToLog}),{itemId:s.id,fileName:s.name}},{end:!0,cancel:"error"})})}(e,t,n,w);U=r.itemId,F=t.filename}else{const r=await async function(e,t,n,r,i,s){const c=S(t.filePath),l=encodeURIComponent(t.filename),d=`${(0,u.lA)(new URL(t.siteUrl))}/drives/${t.driveId}/items/root:${c}/${l}`,p=A(r),f=(0,m.wF)(t.createLinkType);return $({containerSnapshot:p,getAuthHeader:e,logger:n,initialUrl:`${d}:/opStream/snapshots/snapshot${f?`?${f}`:""}`,forceAccessTokenViaAuthorizationHeader:s,epochTracker:i,telemetryName:"CreateNewFile",fetchType:"createFile",validateResponseCallback:e=>{if(!e?.itemId)throw new o.OI("ODSP CreateFile call returned no item ID",a.E.incorrectServerResponse,{driverVersion:h.z})}})}(e,t,n,y,w,v);U=r.itemId,O=r.id,L=function(e,t){let n;if(t){const{sharing:t}=e;if(!t)return;n={createLink:{link:t.sharingLink?{scope:t.sharingLink.scope,role:t.sharingLink.type,webUrl:t.sharingLink.webUrl,...t.sharingLink}:void 0,error:t.error,shareId:t.shareId}}}return n}(r,N)}const E=(0,l.m)({...t,itemId:U,dataStorePath:"/"}),P=new p.Y,H=await P.resolve({url:E,headers:{[c.t.isClpCompliantApp]:k}});if(b.docId=H.hashedDocumentId,b.resolvedUrl=H,H.context=I?.context,H.appName=I?.appName,H.codeHint=H.codeHint?.containerPackageName?H.codeHint:I?.codeHint,L?.createLink?.link){let e=L.createLink.link.webUrl;e=(0,m.z6)(e,H,H.dataStorePath??"/",H.codeHint?.containerPackageName),L.createLink.link.webUrl=e}if(H.shareLinkInfo=L,H.pendingRename=F,void 0!==y&&g){(0,r.vA)(void 0!==O,515);const e=T(y,O);await w.put((0,m.wL)(H,(0,m.JH)((0,i.Ln)(n).config)),e)}return H}function S(e){return e?encodeURIComponent(e.startsWith("/")?e:`/${e}`):""}async function F(e,t,n,r,i){const c=`${(0,u.lA)(new URL(t.siteUrl))}/drives/${t.driveId}/items/${t.itemId}?@name.conflictBehavior=rename`;return(0,m.gO)(async t=>{const l=c,p=await e({...t,request:{url:l,method:"PATCH"}},"renameFile");return s.Bt.timedExecAsync(r,{eventName:"renameFile"},async e=>{const t=(0,d.b)(p);t["Content-Type"]="application/json";const s=await(0,f.M)(async()=>i.fetchAndParseAsJSON(l,{body:JSON.stringify({name:n}),headers:t,method:"PATCH"},"renameFile"),"renameFile",r),c=s.content;if(!c?.id)throw new o.OI("ODSP RenameFile call returned no item ID (for empty file)",a.E.incorrectServerResponse,{driverVersion:h.z});return e.end({...s.propsToLog}),c},{end:!0,cancel:"error"})})}var L=n(24106);async function O(e,t,n,r,o,a,s,d,h){if(void 0===r)throw new L.e("createNewSummary must exist to create a new container");const f=`${(0,u.lA)(new URL(t.siteUrl))}/drives/${t.driveId}/items/${t.itemId}`,y=A(r),w=`${f}/opStream/snapshots/snapshot`,{id:b}=await $({containerSnapshot:y,getAuthHeader:e,logger:n,initialUrl:w,forceAccessTokenViaAuthorizationHeader:d,epochTracker:o,telemetryName:"CreateNewContainerOnExistingFile",fetchType:"uploadSummary"}),g=(0,l.m)({...t,dataStorePath:"/"}),v=new p.Y,k=await v.resolve({url:g,headers:{[c.t.isClpCompliantApp]:h}});if(a.docId=k.hashedDocumentId,a.resolvedUrl=k,s){const e=T(r,b);await o.put((0,m.wL)(k,(0,m.JH)((0,i.Ln)(n).config)),e)}return k}},52076:(e,t,n)=>{n.d(t,{hK:()=>a});var r=n(86664),o=n(84693);function a(e){const t=e.type===o.Z.Handle?e.handleType:e.type;switch(t){case o.Z.Blob:case o.Z.Attachment:return"blob";case o.Z.Tree:return"tree";default:(0,r.$)(t,`Unknown type: ${t}`)}}},86664:(e,t,n)=>{function r(e){throw new Error(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case")}n.d(t,{$:()=>r})}}]);
//# sourceMappingURL=createNewModule.86f9750c.chunk.js.map