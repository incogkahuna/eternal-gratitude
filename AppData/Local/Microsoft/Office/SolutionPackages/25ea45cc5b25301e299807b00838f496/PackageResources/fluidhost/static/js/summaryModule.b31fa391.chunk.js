/*! For license information please see summaryModule.b31fa391.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[11133],{52076:(e,t,r)=>{r.d(t,{hK:()=>s});var n=r(86664),a=r(84693);function s(e){const t=e.type===a.Z.Handle?e.handleType:e.type;switch(t){case a.Z.Blob:case a.Z.Attachment:return"blob";case a.Z.Tree:return"tree";default:(0,n.$)(t,`Unknown type: ${t}`)}}},67300:(e,t,r)=>{r.r(t),r.d(t,{OdspSummaryUploadManager:()=>u});var n=r(41818),a=r(85038),s=r(86664),o=r(84693),i=r(52076),c=r(34904),l=r(63520),d=r(27250),h=r(58358),m=r(70530);class u{constructor(e,t,r,n,a){this.snapshotUrl=e,this.getAuthHeader=t,this.epochTracker=n,this.relayServiceTenantAndSessionId=a,this.mc=(0,l.Ln)(r)}async writeSummaryTree(e,t){void 0!==this.lastSummaryProposalHandle&&this.lastSummaryProposalHandle!==t.proposalHandle&&this.mc.logger.sendTelemetryEvent({eventName:"LastSummaryProposedHandleMismatch",ackedSummaryProposedHandle:t.proposalHandle,lastSummaryProposalHandle:this.lastSummaryProposalHandle});const r=await this.writeSummaryTreeCore(t.ackHandle,t.referenceSequenceNumber,e),n=r?r.id:void 0;if(!r||!n)throw new Error("Failed to write summary tree");return this.lastSummaryProposalHandle=n,n}async writeSummaryTreeCore(e,t,r){const n=(0,c.ub)(r),{snapshotTree:a,blobs:s}=await this.convertSummaryToSnapshotTree(e,r,".app"),o={entries:a.entries,message:"app",sequenceNumber:t,type:n||void 0===e?"container":"channel"};return(0,m.gO)(async r=>{const n=`${this.snapshotUrl}/snapshot`,a=await this.getAuthHeader({...r,request:{url:n,method:"POST"}},"WriteSummaryTree"),i=(0,h.b)(a);i["Content-Type"]="application/json";const c=this.relayServiceTenantAndSessionId();void 0!==c&&(i["If-Match"]=`fluid:sessionid=${c}${e?`;containerid=${e}`:""}`);const l=JSON.stringify(o);return d.Bt.timedExecAsync(this.mc.logger,{eventName:"uploadSummary",attempt:r.refresh?2:1,hasClaims:!!r.claims,hasTenantId:!!r.tenantId,blobs:s,size:l.length,referenceSequenceNumber:t,type:o.type},async()=>(await this.epochTracker.fetchAndParseAsJSON(n,{body:l,headers:i,method:"POST"},"uploadSummary")).content)})}async convertSummaryToSnapshotTree(e,t,r){let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.mc.config.getBoolean("Fluid.Driver.Odsp.MarkUnreferencedNodes")??!0;const l={type:"tree",entries:[]};let d=0;const h=Object.keys(t.tree);for(const m of h){(0,a.vA)(!m.includes("/"),2509);const h=t.tree[m];let u,p,y,b;switch(h.type){case o.Z.Tree:{const t=await this.convertSummaryToSnapshotTree(e,h,r);p=t.snapshotTree,y=c?h.unreferenced:void 0,b=h.groupId,d+=t.blobs;break}case o.Z.Blob:p="string"===typeof h.content?{type:"blob",content:h.content,encoding:"utf-8"}:{type:"blob",content:(0,n.Km)(h.content,"base64"),encoding:"base64"},d++;break;case o.Z.Handle:{if(!e)throw new Error("Parent summary does not exist to reference by handle.");let t=h.handle;t.length>0&&!t.startsWith("/")&&(t=`/${t}`);u=`${e}/${`${r}${t}`}`;break}case o.Z.Attachment:u=h.id;break;default:(0,s.$)(h,`Unknown type: ${h.type}`)}const S={path:m,type:(0,i.hK)(h)};let f;if(p)(0,a.vA)(void 0===u,173),f={value:p,...S,unreferenced:y,groupId:b};else{if(!u)throw new Error(`Invalid tree entry for ${h.type}`);f={...S,id:u}}l.entries.push(f)}return{snapshotTree:l,blobs:d}}}},86664:(e,t,r)=>{function n(e){throw new Error(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case")}r.d(t,{$:()=>n})}}]);
//# sourceMappingURL=summaryModule.b31fa391.chunk.js.map